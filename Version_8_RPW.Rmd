---
title: "Cost-benefit analysis of conservation policy under climate change: The red palm weevil in Catalonia, Spain"
author:
  - name: Ángela Delgado Castillo
    affiliation: a
    footnote: "Corresponding Author: LuzAngela.Delgado@uab.cat"
  - name: Jeroen C.J.M.van den Bergh
    affiliation: a,b,c
  - name: Víctor Sarto i Monteys
    affiliation: a,d
address:
  - code: a
    address: Institute of Environmental Science and Technology, Universitat Autònoma de Barcelona, Edifici Z, 08193 Bellaterra, Spain.
  - code: b
    address: ICREA, Barcelona, Spain.
  - code: c
    address: School of Economics and Business, and Institute for Environmental Studies, VU University Amsterdam, The Netherlands.
  - code: d
    address: Departament d'Agricultura, Ramaderia, Pesca, Alimentació i Medi Natural Generalitat de Catalunya, Avinguda Meridiana, 38 08018, Barcelona, Spain.
abstract: |
   Invasive species are costly for human health, the environment and the economy while their burden is expected to rise. With limited budgets to address biological invasions, prioritisation is key for effective resource allocation. In the past decade, multiple frameworks have emerged to support this budgeting, but it is not clear if current strategies are consistent with these. Amongst invasive species, insects are the costliest. In this article we evaluate a set of conservation policies in response to the arrival of the invasive beetle, the red palm weevil (*Rhynchophorus ferrugineus*) in Catalonia, Spain. The purpose of the selected schemes was to preserve palm species serving ornamental purposes. In a region with a large portion of land dedicated to agricultural activities and with densely populated coastal areas, budgets to address biological invasions should be carefully allocated. Through a comprehensive cost-benefit analysis based on the total economic value framework, we find that current policies were not justified as their net social benefits are negative.
keywords: "Environmental valuation, *Phoenix. spp*, ecosystem services, *Rhynchophorus ferrugineus*."
  
date: "`r Sys.Date()`"
bookdown:
    fig_caption: yes
bibliography: library.bib
csl: apa.csl
header-includes:
   - \usepackage{caption,setspace,titlesec,threeparttable}
      \usepackage[section]{placeins}
      \usepackage[left=3cm, right=3cm, top=3cm]{geometry}
      \usepackage[labelsep=period]{caption}
      \usepackage{breakcites}
      \captionsetup[table]{font={normalsize,it},labelfont={normalsize,it}}
      \captionsetup[figure]{font={normalsize,it},labelfont={normalsize,it}}
      \doublespacing
output: rticles::elsevier_article
editor_options: 
  chunk_output_type: console
---
\makeatletter
\def\ps@pprintTitle{%
\let\@oddhead\@empty
\let\@evenhead\@empty
\def\@oddfoot{\reset@font\hfil\thepage\hfil}
\let\@evenfoot\@oddfoot
}
\makeatother


```{r setup, include=FALSE}
rm(list = ls())

here::set_here()
x <-
  c("tidyverse",
    "officer",
    "jsonlite",
    "httr",
    "base64enc",
    "rlist",
    "RefManageR",
    "openxlsx",
    "BMA",
    "BAS",
    "statsr",
    "MASS",
    "deSolve",
    "FME",
    "RUnit",
    "plyr",
    "gdata",
    "citr",
    "FinancialMath",
    "quantmod",
    "lubridate",
    "stringr",
    "here",
    "dummies",
    "ggmap",
    "car",
    "scales",
    "DescTools",
    "gvlma",
    "MASS",
    "QuantPsyc",
    "Hmisc",
    "GGally",
    "lm.beta",
    "MuMIn",
    "broom",
    "skimr",
    "bookdown",
    "knitr",
    "kableExtra",
    "kable",
    "formatR",
    "gridExtra",
    "DataExplorer",
    "corrplot",
    "stats")


lapply(x, require, character.only = TRUE)

opts_chunk$set(echo = FALSE)
options(knitr.table.format = "latex")
knit_hooks$set(inline = function(x) {
  prettyNum(round(x,2), big.mark=",")
})

```

1. Introduction
==========================

\noindent The introduction of invasive alien species (IAS) can be considered to be an important feature of the Anthropocene [@capinhaDispersalAlienSpecies2015; @lewisDefiningAnthropocene2015]. A worldwide growth in trade and transport during the past two centuries has increased the rate at which new IAS appear [@costelloUnintendedBiologicalInvasions2007; @pysekInvasiveSpeciesEnvironmental2010]. Depending on the taxonomic classification, 1-16% of all species on Earth qualify as potential alien species. For most taxonomic groups, the greater part of potential invasions has yet to occur [@seebensGlobalRiseEmerging2018].  

IAS often have a negative impact on human health, the economy and ecosystems
[@bradshawMassiveGrosslyUnderestimated2016; @colauttiCharacterisedProjectedCosts2006; @painiGlobalThreatAgriculture2016; @pimentelUpdateEnvironmentalEconomic2005; @vazquez-prokopecUnforeseenCostsCutting2010; @williamsEconomicCostInvasive2010].
Invasive insects (II) are likely to be the costliest species to humans with an annual minimum cost estimation of USD 70 billion globally [@bradshawMassiveGrosslyUnderestimated2016]. There are about 1.84 to 2.57 million insects species [@moraHowManySpecies2011] and to date, only an approximate 24% of potential insect invasions have taken place [@seebensGlobalRiseEmerging2018]. Depending on the policy implemented to lower the probability of these invasions, the cost will be typically assumed by taxpayers, private entities, and residential property owners [@fenichelControlInvasiveSpecies2014; @funkBroadeningCaseInvasive2014; @lovettNonnativeForestInsects2016; @martelliEconomicImpactDengue2015; @vandammeOutofpocketHealthExpenditure2004].

To minimise costs borne by II, often the best policies are preventive which include measures in exporting countries and inspections of shipments at ports of entry [@lovettNonnativeForestInsects2016]. In instances of effective II introduction, governments can apply post-entry measures such as quarantines, surveillance and eradication programs [@kellerInternationalPolicyOptions2011; @thompsoncampbellFadingForestsNorth1994]. However, when budgets to address biological invasions are limited and invasions are rising, what should governments and individuals do? Prioritisation of which species, pathways, or sites to address is key [@mcgeochPrioritizingSpeciesPathways2016], as stated in Target 9 of the Aichi Biodiversity Targets of Convention on Biological Diversity [@conventiononbiologicaldiversityAichiBiodiversityTargets]. 

In this article we explore a set of conservation policies designed to address the arrival of an invasive insect. Our aim is to understand to what extent the crucial concept of prioritisation is being implemented in current policies. This assessment supports policy makers at a local, regional and international level to improve resource allocation by considering the environmental and possibly socio-economic impacts [@blackburnUnifiedClassificationAlien2014; @kumschickConceptualFrameworkPrioritization2012] and choosing actions that best avoid or lessen the impact of invasive species [@mcgeochPrioritizingSpeciesPathways2016].

The conservation policies selected [^1] were designed to preserve two highly valued plant species: *Phoenix dactylifera* (the Date palm) and *Phoenix canariensis* (the Canary palm), both non-native and considered of 'least concern' by the IUCN Global Species Programme Red List Unit [@beechPhoenixCanariensisIUCN2017] but susceptible to an II in Catalonia, Spain. These two species have come under pressure in the region of study due to the arrival of the red palm weevil (*Rhynchophorus ferrugineus*, Coleoptera: Dryophthoridae) or as it is known locally, the ‘morrut de les palmeres’ (Catalan for palm weevil). II such as the red palm weevil (RPW) are introduced through trade and transport [@costelloUnintendedBiologicalInvasions2007; @margolisHowTradePolitics2005; @meyersonInvasiveAlienSpecies2007]. Merchandise imports [@levineForecastingBiologicalInvasions2003] and economic and demographic variables have been found to influence invasion levels [@pysekDisentanglingRoleEnvironmental2010].

[^1]: The selected policies are formulated in Ordre ARP/343/2006, Ordre AAR/226/2009, Ordre AAR/2802/2010, and Ordre AAM/56/2011. These are explained in further detail in the Appendix A.

Specific policies have been implemented in Catalonia to mitigate the impact on susceptible palm species caused by the RPW. We will use a combination of dynamic modelling and a cost-benefit analysis to assess the selected policies. This approach has recently been argued to overcome pitfalls present in other methods [@courtoisCostBenefitApproach2018]: (1) prioritisations are sometimes based on expert judgements and scores are debatable, (2) scores summation is difficult, (3) inclusion of management expenditure is not usual, and (4) relationships between species are often excluded.

2. The RPW around the world and in Catalonia
==========================

\noindent The RPW is native to Southeast Asia and Polynesia [@wattanapongsiriRevisionGeneraRhynchophorus1966] being essentially a pest of palms *(Arecaceae)*, with 29 species listed as host plants [@cabiDatasheetRhynchophorusFerrugineus2017]. It has been suggested to also harm sugarcane, Saccharum officinarum, *(Poaceae)* and sentry plants or maguey, *Agave americana (Agavaceae)* [@cabiDatasheetRhynchophorusFerrugineus2017] although this still awaits rigorous confirmation. The RPW was introduced in other parts of the world mainly through imports of palm trees or offshoots from native areas. For instance, it reached Egypt in 1992 from the United Arab Emirates, and Spain in 1995 from imported Egyptian palms [@ferryRedPalmWeevil2002].


The RPW lays eggs on the crown of palm trees. Larvae then penetrate it eventually reaching the crown core where the meristematic tissue resides. Subsequent feeding on this tissue will eventually kill the palm tree. Because the whole larval stage occurs within the palm tree, it is concealed from plain eyesight and hence hard to detect. 

In Spain, palm damage by this beetle was first observed in 1993 on the coastal front of the Granada province [@barrancoNuevoCurculionidoTropical1996]. In 2004 it reached the Autonomous Community of Valencia [@eppoRhynchophorusFerrugineus2008]. It was officially declared  a pest in Catalonia in 2006 [@generalitatdecatalunyaOrdreARP3432006] where it presumably arrived between 2003 and 2004 to the Ebro river delta and Tarragona region (South Catalonia). Figure \ref{fig:catalonia} shows the invasion status of RPW in Catalonia up to November 2016 [@generalitatdecatalunyaRedPalmWeevil2017].

\begin{figure}[!htb]
\centerline{\includegraphics[width=20pc]{2016invasion.png}} 
\caption{RPW invasion status in 2016, the invaded area reported by GENCAT is coastal and for the most part, overlaps spatial population distribution. Source: GENCAT, 2017.}
\label{fig:catalonia} 
\end{figure}

Several other areas in the Mediterranean have been colonised by the pest. Sicily, for instance, was reached in 2005. Here palm damage was categorised as a threat to cultural heritage [@manachiniExoticInsectPests2013; @periRedPalmWeevil2013]. Other countries where it appeared for the first time in this period include Turkey (2005), Cyprus (2006), Greece (2006) and Malta (2007) [@mizziRedPalmWeevil2009; @yuezhongRedPalmWeevil2009].
The beetle has also invaded other parts of the world. In Japan, it was first observed in 1975 in the island of Okinawa, and in 1998 it spread northwards to the island of Kyushu [@abeLifeHistoryRed2009]. During the 1990s, the RPW was intercepted on several occasions in China. In 2007, several cases in the Zhejiang province were detected signalling a spread throughout Southern China [@yuezhongRedPalmWeevil2009]. Other Asian countries where the RPW is present include: India, Pakistan, Sri Lanka, Myanmar, Indonesia, the Philippines, and the Gulf states [@abeLifeHistoryRed2009]. In the Americas, the RPW was detected in the Caribbean islands of Aruba and Curaçao in 2009 which meant a risk of the weevil being exported to South America [@rodaRedPalmWeevil2011]. On October 2010, the USDA’s Animal and Plant Health Inspection Service (APHIS) announced the arrival of the closely related species *Rhynchophorus vulneratus* to the city of Laguna Beach, California. Today, the RPW is present in over 70 countries [@cabiDatasheetRhynchophorusFerrugineus2017]. 

In Catalonia, Spain, there are over 800 gardens, nurseries and plant traders combined, 24% of them trading with palm trees. Catalonia has five administrative regions, all of them involved in trading palms which helps increase the risk of RPW expansion (Table \ref{tab:nurseries}). Places with large volumes of trade and transport and adjacent to high human population densities, likely benefit from prioritizing invasions [@mcgeochPrioritizingSpeciesPathways2016], this is the reason for selecting Catalonia as the case study. 

```{r nurseries, echo=FALSE}
options(scipen = 999, digits = 2)
all_nurseries <- c(348, 162, 148, 98, 106, 862)
palm_nurseries <- c(59, 63, 10, 36, 37, 205)
region <-  c("Barcelona",
             "Girona",
             "Lleida",
             "Tarragona",
             "Terres de l'Ebre",
             "Total")
df_nurseries <- data_frame(region,
                           palm_nurseries,
                           all_nurseries)
df_nurseries$region <- as.factor(df_nurseries$region)
colnames(df_nurseries) <- c("Region",
                            "With palms",
                            "All")
df_nurseries <- df_nurseries %>%
  mutate(Ratio = `With palms` / All)
kable(
  df_nurseries,
  caption = "Gardens, nurseries and plant traders in Catalonia per Administrative Region. Source: GENCAT, 2018.",
  booktabs = T,
  escape = F
) %>%
  kable_styling(latex_options = c("hold_position"))%>%
  footnote(general="",
           general_title = "",
                     footnote_as_chunk = T, threeparttable = TRUE)
```

3. Method
============

3.1 Cost-benefit analysis
============
\noindent We will perform a cost-benefit analysis assessing a set of conservation policies put into place to protect two susceptible species from the RPW: canary and date palms [@generalitatdecatalunyaOrdreARP3432006]. The former was reported in 99.69% and the latter in 0.23% of RPW infestation cases in Catalonia [@generalitatdecatalunyaPrevencioLluitaContra2011]. Although date palms currently represent a small fraction of reports, we include them because in the absence of canary palms, the RPW would likely shift to that species. 
The first step of a cost-benefit analysis is to define what constitute as costs and benefits. We interpret as costs all policy expenditures with the direct aim of preserving and protecting palm trees from the RPW. This covers the prevention and inspection of healthy palms, treatment of infested palms and removal of palms that are too infested to be salvaged, and government expenditure associated with surveying, research, regulation, management and outreach linked to the RPW [@aukemaEconomicImpactsNonNative2011]. 

To better understand the rationale behind the accounting used in this study, a few remarks on the policies are relevant. The main variation in terms of the funding agent is that in 2011, inspection, prevention, treatment and removal costs were transferred from the Catalonian goverment (GENCAT) to municipalities and private owners. From 2005 to 2011, GENCAT was responsible for research and outreach in addition to the management activities described (excluding replanting). From 2011, onwards, municipalities and property owners were made responsible for management activities while GENCAT continues funding research and outreach. Although replanting is not explicit in the policies, between 2005 to present, the local media has reported some replanting iniatives [@congostrinaBarcelonaPlantaPalmeras2017; @puricaroBarcelonaAtesora242017], we therefore include replanting on behalf of municipalities and property owners throughout the entire period.

To define benefits, we will use the total economic value (TEV) framework [@ledouxValuingOceanCoastal2002]. It classifies the value of an asset into two main categories: use and non-use values. The main difference between these is that use values are related to the use of the asset while non-use values relate to the motivation for conserving the asset for future generations or for its own sake (existence value). Figure \ref {fig:tev} further illustrates this point by listing indirect and direct values derived from palm trees. The former includes aesthetic benefits and carbon sequestration. Although in some places palm trees have direct values (i.e. cultivation), as will be described in the following paragraphs, in the scope of this article, no direct values were identified. 

\begin{figure}[!htb]
\centerline{\includegraphics[width=30pc]{tev.png}} 
\caption{Total economic value framework for canary and date palms in Catalonia. For use values, we identify as indirect benefits, aesthetic values and carbon sequestration. No direct values are identified.}
\label{fig:tev}
\end{figure}

Canary and date palms are non-native to the Iberian Peninsula. They were introduced in ancient times appearing in depictions of late Iberian pottery and coinage dating back to the third to first century BC [@al-khayriDatePalmGenetic2015]. Although canary palms produce edible fruits, they do not meet the standards required for agriculture. In Spain, the land area dedicated to date cultivation is marginal with an average of ca. 600 hectares since 1961 to present [@faostatdatabaseDownloadDataCrops2018]. In Catalonia, our region of study, date cultivation is virtually non-existent. Palms are planted in urban areas, resorts, public spaces and private gardens mainly near the coast [@al-khayriDatePalmGenetic2015]. Currently, they are classified as species of "least concern" on the IUCN Red List of Threatened Species [@beechPhoenixCanariensisIUCN2017], meaning they do not qualify as threatened, near threatened or conservation dependent.

Given their almost exclusive ornamental use, we identify two indirect use values of palm trees as benefits: carbon sequestration and enhanced aesthetic value, the latter being the main reason behind palm tree availability in Catalonia. 


3.2 A dynamic model of tree stocks under RPW infestation
============

\noindent We modelled the evolution of tree stocks as a system dynamics problem using stocks, flows and feedback loops since this approach allows us to understand nonlinear behavior over time. The two palm species considered in this study have similar processes with different initialisation values so we implemented two separate modules of the same model. From this point onward, susceptible palm species will be referred to as *trees*. The model was designed with three stocks: healthy, infested and treated trees. Figure \ref{fig:model} illustrates the model using Vensim software [@ventanasystemsinc.VensimPLESoftware1992].

\begin{figure}[!htb]
\centerline{\includegraphics[width=30pc]{model.png}} 
\caption{The model has three main stocks: healthy, infested, and treated trees. Each stock has ingoing and outgoing flows that depend on external and internal mechanics. For example, the healthy tree stock depends on the replanting flow, which in turn depends on external decisions. In contrast, the number of infested trees is part of a positive feedback loop where more infested trees lead to a larger pool of infested trees.}
\label{fig:model}
\end{figure}

The total amount of trees, $S_t$, at time $t$, will be the sum of healthy trees, $S_t^H$, the sum of infested trees, $S_t^I$, and the sum of trees in treatment, $S_t^T$.

\begin{equation} 
\label{eq:total_stock}S_t=S_t^H+S_t^I+S_t^T
\end{equation}

Healthy trees, $S_t^H$, are all susceptible trees with two incoming flows: replanted trees, $F_{t,t-1}^R$, and successfully treated trees, $F_{t,t-1}^{ST}$. Prevention consists of a series of chemical applications to reduce tree vulnerability to the pest. Outgoing flows are trees in which prevention has failed, $F_{t,t-1}^{FP}$. Therefore, the equation for the healthy net flow, $S_t^H-S_{t-1}^H$, between $t-1$ and $t$ is:

\begin{equation} 
\label{eq:stock_healthy}S_t^H-S_{t-1}^H=F_{t,t-1}^R+F_{t,t-1}^{ST}-F_{t,t-1}^{FP}
\end{equation}

The outflow, $F_{t,t-1}^{FP}$, depends on the force of infestation, denoted by lambda ($\lambda_t$). The force of infestation is the rate at which susceptible trees become infested per unit time. It is adapted from the force of infection [@vynnyckyIntroductionInfectiousDisease2010]. The rate of infestation is related to the number of infested trees, $S_t^I$: the more trees are infested, the more likely more trees will become infested and to the average number of trees that are planted next to each other, denoted by Beta $\beta_t$. 

The force of infestation, $\lambda_t$, at time $t$ is:

\begin{equation} 
\label{eq:lambda}\lambda_t=\beta_t*S_t^I
\end{equation}						 

$\beta_t$ in turn, depends on the effective contact rate ($C_E$), defined as the contact rate sufficient to lead to transmission if it occurs between an infested and a susceptible tree [@vynnyckyIntroductionInfectiousDisease2010] with units $\frac{palms}{(palm/year)}$ and on the total stock, $S_t$, at time $t$.

\begin{equation} 
\label{eq:beta}\beta_t=\frac{C_E}{S_t}		
\end{equation}	

The failed prevention outflow, $F_{t,t-1}^{FP}$, is the outflow of trees in which prevention has failed ($FP$) product of the number of healthy trees, $S_t^H$, and $\lambda_t$ the force of infection at time $t$.

\begin{equation} 
\label{eq: failed prevention}F_{t,t-1}^{FP}=S_t^H*\lambda_t
\end{equation}

Failed prevention, $F_{t,t-1}^{FP}$, is an incoming flow to the infested tree stock, $S_t^I$. Infested trees are either treated, $F_{t,t-1}^{TR}$, or not treated, $F_{t,t-1}^{UTR}$, leading to two outgoing flows for this stock. Therefore, the equation for the net infested flow between $t-1$ and $t$ is:

\begin{equation} 
\label{eq: stock_infested}S_t^I-S_{t-1}^I=F_{t,t-1}^{FP}-F_{t,t-1}^{UTR}-F_{t,t-1}^{TR}
\end{equation}

Both treated, $F_{t,t-1}^{TR}$, and untreated flows, $F_{t,t-1}^{UTR}$, depend on the probability $\tau$, of being treated:

\begin{equation} 
\label{eq: treated_prob}F_{t,t-1}^{TR}=S_{t-1}^I*\tau
\end{equation}

\begin{equation} 
\label{eq: untreated_prob}F_{t,t-1}^{UTR}=S_{t-1}^I-F_{t,t-1}^{TR}
\end{equation}

Trees selected for treatment, $F_{t,t-1}^{TR}$, is an incoming flow to the treated trees stock, $S_t^T$. The latter has outgoing flows representing either failed, $F_{t,t-1}^{FT}$, or successful treatment, $F_{t,t-1}^{ST}$. Thus,

\begin{equation} 
\label{eq: stock_treated}S_t^T-S_{t-1}^T=F_{t,t-1}^{TR}-F_{t,t-1}^{FT}-F_{t,t-1}^{ST}
\end{equation}

Both successful, $F_{t,t-1}^{ST}$, and failed treatment flows, $F_{t,t-1}^{FT}$, depend on the probability of successful treatment $\sigma$:

\begin{equation} 
\label{eq: successful_treatment}F_{t,t-1}^{ST}=S_t^T*\sigma
\end{equation}
\begin{equation} 
\label{eq: failed_treatment}F_{t,t-1}^{FT}=S_t^T-F_{t,t-1}^{ST}
\end{equation}

Finally, to keep track of trees that were lost each year due to lack of treatment, $F_{t,t-1}^{UTR}$ or failed treatment, $F_{t,t-1}^{FT}$, we define the lost flow, $F_{t,t-1}^L$, between $t-1$ and $t$ as:

\begin{equation} 
\label{eq: lost_flow}F_{t,t-1}^L=F_{t,t-1}^{UTR}+F_{t,t-1}^{FT}
\end{equation}

Similarly to keep track of trees that have been replanted each year, $S_t^R$, due to the incoming flow of replanted trees, $F_{t,t-1}^R$, we define the stock of replanted trees $S_t^R-S_{t-1}^R$, between $t-1$ and $t$ as:

\begin{equation} 
\label{eq: replanted_stock}
S_t^R-S_{t-1}^R=F_{t,t-1}^R
\end{equation}

\subsubsection{Costs}

\noindent We now introduce equations to calculate costs. These are divided into two main groups. The first is management costs assumed by municipalities and private palm owners from 2011 onwards. These management costs, $M_t$, for trees in year $t$ are described as the sum of inspection ($C_t^{inspect}$), prevention ($C_t^{prevent}$), treatment costs ($C_t^{treat}$), replanting ($C_t^{replant}$), and removal costs ($C_t^{remove}$). The second group is government (GENCAT) costs which includes management costs (except replanting) but also additional activities such as research and outreach. These were provided from 2005 to 2017 and since no specific breakdown was provided by GENCAT so they are added as a lump sum ($C_t^{GENCAT}$).

\begin{equation}
\label{eq:management_costs}M_t=C_t^{inspect}+C_t^{prevent}+C_t^{treat}+C_t^{replant}+C_t^{removal}+C_t^{GENCAT}
\end{equation} 
    	
\noindent Inspection costs, $C_t^{inspect}$, are the costs of inspecting healthy trees in year $t$. Here, we multiply by the stock since this is a cost that applies to all trees year after year.

\begin{equation} 
\label{eq:inspection_costs}C_t^{inspect}=S_t^H*c^{inspect}
\end{equation} 						
 								 
Here \noindent $S_t^H$, is the number of healthy trees ($H$) in year $t$ and $c^{inspect}$ is the inspection unit cost. Prevention costs, $C_t^{prevent}$, are the costs of applying preventative treatments to healthy trees in year $t$. Here, again, we multiply by the stock since this is a cost that applies to all trees every single year.

\begin{equation} 
\label{eq:prevention_costs}C_t^{prevent}=S_t^H*c^{prevent}
\end{equation} 
  												
\noindent Here, $S_t^H$ is the number of healthy trees ($H$) in year $t$ and $c^{prevent}$ is the prevention unit cost. Treatment costs, $C_t^{treat}$, are the costs of treating a tree selected for treatment ($T$) to improve its health in year $t$. We multiply by the flow since we treat newly infested trees.

\begin{equation}
\label{eq:treatment_costs}C_t^{treat}=F_{t,t-1}^{FP}*c^{treat}
\end{equation} 									

\noindent Here, $F_{t,t-1}^{FP}$ is the flow of trees with failed prevention ($FP$) between $t-1$ and $t$, and $c^{treat}$ is the treatment unit cost. Replanting costs, $C_t^{replant}$, are the costs of replanting trees in year $t$.

\begin{equation} 
\label{eq:replanting_costs}C_t^{replant}=F_{t,t-1}^{replant}*c^{replant}
\end{equation} 	

\noindent Here, $F_{t,t-1}^{replant}$, is the flow of replanted trees ($R$) between $t-1$ and $t$, and $c^{replant}$ is the unit cost of replanting a new tree. $C_t^{remove}$, corresponds to the costs of permanently removing a tree in year $t$, which the pest has damaged beyond the point of treatment, $F_{t,t-1}^L$.

\begin{equation} 
\label{eq:removal_costs}C_t^{remove}=F_{t,t-1}^L*c^{remove}
\end{equation} 						     	

\noindent Here, $F_{t,t-1}^L$ is the number of lost trees between $t-1$ and $t$, and $c^{remove}$ is the unit cost of removing a lost tree.


\subsubsection{Benefits}

\noindent As mentioned in the introduction, trees provide different benefits ($VB$). We will consider two benefits provided by palm trees in Catalonia (Eq. \ref{eq:benefits}): (1) those derived from carbon sequestration, and (2) those derived from forestry adjacency, or in this instance, palm tree adjacency.

\begin{equation} 
VB=VCS+VPA
\label{eq:benefits}
\end{equation}

Where, $VCS$ is the value derived from carbon sequestration by palm trees in Catalonia and $VPA$ is the value derived from palm tree adjacency. The benefits of carbon sequestration, $VCS$, will be calculated using the social cost of carbon ($SCC$). The social cost of
carbon is an economic indicator that represents the net impacts from global climate change that results from a one tonne increase in carbon dioxide emissions [@iawgTechnicalUpdateSocial2016]. We can then calculate the $VCS$ as follows:

\begin{equation} 
\label{eq:social_cost}VCS=SCC*c*S_t 
\end{equation}

\noindent where, $SCC$ is the social cost of carbon dioxide, $c$ is the amount of carbon sequestered by a tree; and $S_t$ is the total tree stock in year $t$.

Benefits of tree adjacency can be captured by using the hedonic property-value method. This allows to estimate the aesthetic value trees contribute to property sale prices. Several studies have focused on quantifying forest adjacency [@donovanTreesCityValuing2010; @sanderValueUrbanTree2010; @tyrvainenPropertyPricesUrban2000] with results stating that trees contribute between 0.29 to 5% of property values of private residences.
In this article we attempt to capture the value that, specifically, palm trees contribute to property prices.

We assume that the total value of a property in Catalonian
municipalities, where trees are viable, includes a component of palm trees in addition to other market effects. This component of forestry adjacency is captured in property values ($PV$):

\begin{equation} 
\label{eq:property_values}PV=MP+PA
\end{equation}

\noindent where, $MP$ is the market price of a property without adjacent palm trees and $PA$ is the value derived from palm tree adjacency.

\subsubsection{Total costs and benefits}

\noindent The net social benefits (NSB) of the current management policy against the RPW in Catalonia is the difference between benefits and costs, both transformed into present values (Eq. \ref{eq:nsb}).

\begin{equation} 
\label{eq:nsb}NSB=\sum_{t}\frac{B_{t}-C_{t}}{(1-r)^t}
\end{equation}

\noindent Here, $B_{t}$ denotes the monetary benefits of the policy, $C_{t}$, the management costs and, $r$, the discount rate.



3.3 Estimation of Parameter Values
=====

As explained earlier, the model has three parameters: effective contact rate ($C_E$), probability of being treated $\tau$, and probability of successful treatment ($\sigma$). In this section, we explain the
process to estimate each parameter.

\subsubsection{Effective contact rate ($C_E$)}

\noindent Effective contact rate, $C_E$, is defined as the sufficient contact rate to lead to transmission if it occurs between an infested and a susceptible tree [@vynnyckyIntroductionInfectiousDisease2010] with units $\frac{palms}{(palm/year)}$. Since palm trees in Catalonia are often planted in a single file, a single tree can have two neighboring trees. $C_E$ can take up values [1,$\infty$] but we limited it to the range [1,2] since a single infested tree can infest up to two trees.

\subsubsection{Probability of being treated ($\tau$)}

\noindent With the goal of eliciting treatment and treatment success probabilities, we conducted interviews with three government officials and two local independent firms offering pest management services (healthy tree inspection and prevention, and infested tree treatment and removal). The probability that an infested tree is treated, $\tau$, can take values between [0,1]. We limited our analysis to the interval [0.5,1]. Since legislation states that treatment of all affected trees is mandatory, we assigned 1 to the upper boundary for the case in which 100% of infested trees are treated. According to interviewees, there are instances where infested tree treatment does not occur. This may happen deliberately or accidentally. Furthermore, no official data exists describing the behaviour of private owners while municipality reports are undecided since they must reflect compliance with the law. In order to account for this unknown behaviour where treatment does not occurr but is unknown, the lower boundary was set to a probability of 0.5 (i.e.~ coin toss).

\subsubsection{Probability of successful treatment ($\sigma$)}

\noindent Sigma ($\sigma$) is the probability that treatment is successful. Again, as it is a probability, it can take values between [0,1]. Success is defined as a tree being sufficiently recovered to rejoin the healthy stock. Interviewees were consistent in their responses stating that once a tree becomes infested, the survival probability is slim to none. For this reason, we assigned [0,0.5] to the interval as it reflects the pessimistic outlook on trees under treatment: from a zero recovery rate up to 0.5 (i.e.~ coin toss).


4. Results
============

In this section we will present calculations for costs, benefits, and the related cost-benefit analysis (Eq. \ref{eq:nsb}). In this section, tables and figures show aggregated results, for detailed tables and figures refer to Appendix C. Recall, we considered two types of benefits provided by palm trees (Eq. \ref{eq:benefits}), those derived from carbon sequestration and others derived from palm tree adjacency. Here we present the results for both calculations. We implemented the model using the deSolve package in R Software [@soetaertSolvingDifferentialEquations2010]. To run the model, two initial stock values had to be defined for $t=2005$, healthy, $S_{2005}^H$, and infested, $S_{2005}^I$, stock. In this section we also explain how these two initialisation values were set.

\subsubsection{Healthy tree stock  in 2005}


Since public tree inventory is decentralised and private owners have the ability to change their landscape, public and private tree records were unavailable. Instead, we estimated tree stocks. To estimate total stock in 2005 (Eq. \ref{eq:2005stock}), $S_{2005}$, we first estimated values for 2017, $S_{2017}$, and added the minimum loss of stock during the invasion period, $S_{2017-2005}^L$. The minimum loss was provided by the regional government (GENCAT). The process for estimating stock in 2017 will be now explained with more detail. 

\begin{equation} 
\label{eq:2005stock}S_{2005}=S_{2017}+S_{2017-2005}^L
\end{equation}

As previously mentioned, the availability of both palm trees in the region of study is human-mediated given its almost exclusive ornamental use. Due to this type of usage, we identified multiple human-centred factors as explanatory variables (population, GDP per sector and municipality area). Furthermore, we consulted two experts in forestry and ornamental plants who suggested distance to the Western Mediterranean Basin plays a key role in the presence of palm trees.

Data for aforementioned variables were retrieved from the Catalonian statistical department (IDESCAT) for all municipalities. Distance was calculated using polygon centroids. GDP per sector was not available for all municipalities, however, it was available for all *comarcas*, which are a higher administrative level. *Comarcas'* GDP per sector was used for municipalities lacking these data. 

To collect data on both species, we counted tree ocurrences using static maps from Google Maps. To select the sample, we chose a stratified sampling strategy where *comarcas* were defined as strata, since we wanted all *comarcas* to be represented within the sample. Initially, we set out to collect a sample size of 50 municipalities. The total number of Catalan municipalities is 947 contained in 42 *comarcas*. For each strata, we calculated the sample size as: $\frac{Sample\ Size}{Total\ population}*Strata\ size$. For example, for the comarca Baix Camp with 28 municipalities, calculations were: $\frac{50}{947}*28=1.48\approx 2\ municipalities$. Repeating this process for all comarcas and rounding decimals upwards yielded 73 municipalities. 

Once the sample was selected, the following procedure was done for each of the 73 municipalities. First, using a 'shapefile' for the region and the R Packages sf and GGMap [@kahleGgmapSpatialVisualization2013], a grid for each municipality was produced where each cell in the grid represented a separate image (Figure \ref{fig:grids}). After this image-generation process was done for each municipality, each of the 25,000 images was individually assessed for palm trees of each species. 

\begin{figure}[!htb]
\centerline{\includegraphics[width=20pc]{grids.png}} 
\caption{The image shows  a municipality grid for Salou, Catalonia. Each point on the map represents a separate image printed at a resolution sufficient to count palm tree occurrence.}
\label{fig:grids} 
\end{figure}

Once observations were collected, we proceeded to decide what model to use to estimate the distribution of palm trees. At this point we had no criteria to select one model over another so Bayes model averaging (BMA) was useful as it weighs multiple models according to their posterior probability. The Bayes Information Criterion ($BIC$)[^2] was used as the prior distribution for regression coefficients since we were in a non-informative situation. The model was specified as follows: the explanatory variables mentioned in the previous paragraphs were included. As a reminder, for each municipality these were: percentage of GDP derived from agriculture, services, construction, and industry; distance to the coast, population, and area. Finally, a uniform distribution was asigned as the model prior since we were in a non-informative situation.

```{r reading collected data, include=FALSE}
#Read palm data
palms <- read.xlsx("palm_counts.xlsx")
palms <- palms[1:73,] #rows 1 through 73
#Create ser, ag, indu and cons variables.
#Aggregate by ownership
palms <- palms %>%
  mutate(canary=canary_priv+canary_pub,
         date=date_priv+date_pub,
         ag=Agriculture/Total,
         indu=Industry/Total,
         cons=Construction/Total,
         ser=Services/Total)

#Read spreadsheet for all municipalities
final<- read.xlsx("final.xlsx")
#Create ser, ag, indu and cons variables.
final <- final %>%
    mutate(
         ag=Agriculture/Total,
         indu=Industry/Total,
         cons=Construction/Total,
         ser=Services/Total)
```

```{r Looking at distributions, include=FALSE}
boxplot_date<- ggplot(palms,aes(x=,y=date))+
  geom_boxplot()+
  coord_flip()

boxplot_canary<- ggplot(palms,aes(x=,y=canary))+
  geom_boxplot()+
  coord_flip()
```

```{r ape, include=FALSE }
set.seed(42)
n <-  nrow(palms)
n_cv <-  50
ape_date <-  matrix(NA, ncol=4, nrow=n_cv)
colnames(ape_date) = c("BMA", "BPM", "HPM", "MPM")

for (i in 1:n_cv) {
  train = sample(1:n, size=round(.90*n), replace=FALSE)
  date_train = palms[train,]
  date_test = palms[-train,]
  
  bma_train_date = bas.lm(date ~  ag+ser+cons+indu+distance+population+area, data=date_train, 
                          prior="BIC", modelprior=uniform(), initprobs="eplogp")
  yhat_bma = predict(bma_train_date, date_test, estimator="BMA")$fit
  yhat_hpm = predict(bma_train_date, date_test, estimator="HPM")$fit
  yhat_mpm = predict(bma_train_date, date_test, estimator="MPM")$fit
  yhat_bpm = predict(bma_train_date, date_test, estimator="BPM")$fit
  ape_date[i, "BMA"] = cv.summary.bas(yhat_bma, date_test$date)
  ape_date[i, "BPM"] = cv.summary.bas(yhat_bpm, date_test$date)
  ape_date[i, "HPM"] = cv.summary.bas(yhat_hpm, date_test$date)
  ape_date[i, "MPM"] = cv.summary.bas(yhat_mpm, date_test$date)
}

boxplot(ape_date)

apply(ape_date, 2, mean)

set.seed(42)
n <-  nrow(palms)
n_cv <-  50
ape_canary <-  matrix(NA, ncol=4, nrow=n_cv)
colnames(ape_canary) = c("BMA", "BPM", "HPM", "MPM")

for (i in 1:n_cv) {
  train = sample(1:n, size=round(.90*n), replace=FALSE)
  canary_train = palms[train,]
  canary_test = palms[-train,]
  
  bma_train_canary = bas.lm(canary ~  ag+ser+cons+indu+distance+area+population, data=canary_train, 
                          prior="BIC", modelprior=uniform(), initprobs="eplogp")
  yhat_bma = predict(bma_train_canary, canary_test, estimator="BMA")$fit
  yhat_hpm = predict(bma_train_canary, canary_test, estimator="HPM")$fit
  yhat_mpm = predict(bma_train_canary, canary_test, estimator="MPM")$fit
  yhat_bpm = predict(bma_train_canary, canary_test, estimator="BPM")$fit
  ape_canary[i, "BMA"] = cv.summary.bas(yhat_bma, canary_test$canary)
  ape_canary[i, "BPM"] = cv.summary.bas(yhat_bpm, canary_test$canary)
  ape_canary[i, "HPM"] = cv.summary.bas(yhat_hpm, canary_test$canary)
  ape_canary[i, "MPM"] = cv.summary.bas(yhat_mpm, canary_test$canary)
}

boxplot(ape_canary)

apply(ape_canary, 2, mean)
```

HERE.
In terms of significant estimators this meant, distance to the coastline, and industry contribution to GDP (%), for date palms; and distance to the coastline, population, and industry contribution to GDP (%), for canary palms. Tables \ref{tab:date_palms_model} and \ref{tab:canary_palms_model} in the Appendix D summarise the model estimates for date and canary palms, respectively.

```{r coefficients, include=FALSE}

lm_date = lm(date ~  ag+ser+cons+indu+distance+population+area, data=palms)


BMA_date <-  bas.lm(date ~  ag+ser+cons+indu+distance+population+area, data = palms,
                      prior = "BIC",
                      modelprior = uniform())

n <- length(BMA_date)
stepAIC(object=lm_date, k =log(n))

lm_canary = lm(canary ~  ag+ser+cons+indu+distance+population+area, data=palms)

BMA_canary <-  bas.lm(canary ~  ag+ser+cons+indu+distance+population+area, data = palms,
                      prior = "BIC",
                      modelprior = uniform())
n <- length(BMA_canary)
stepAIC(object=lm_canary, k =log(n))
```

[^2]:$BIC= -2*log(likelihood)+log(n)*\#parameters$, where $n$ is the sample size. We will have a tradeoff between the goodness of fit (the extent to which observed data matches the values expected by theory) $n*log(1-R^2)$ and the model complexity represented with $log(n)*\#parameters$. We choose the model that has the smallest $BIC$. 

```{r tree models, include=FALSE}
lm_date <- lm(date ~  indu+distance, data=palms)
 
lm_canary <- lm(canary ~  indu+distance+population, data=palms)
```

```{r date predictions, include=FALSE}

date_BMA_prediction<-predict(lm_date,newdata= final) #Apply model to new date
date_BMA_df<- as_tibble(date_BMA_prediction) 
names(date_BMA_df) <- c("date") 
date_BMA_df%>%
  mutate(date=if_else(date>0,date,0) #Remove negatives 
         )->date_BMA_df #Store in new dataframe
test_final <- rownames_to_column(final,var="index") #Adding id to new data
test_interval <- rownames_to_column(date_BMA_df,var="index") #Adding id to predictions
test_date<- test_final %>%
 left_join(test_interval,by="index") #Joining predictions with more info
```

```{r canary predictions, include=FALSE}

canary_BMA_prediction<-predict(lm_canary,newdata= final) #Apply model to new canary
canary_BMA_df<- as_tibble(canary_BMA_prediction) 
names(canary_BMA_df) <- c("canary") 
canary_BMA_df%>%
  mutate(canary=if_else(canary>0,canary,0) #Remove negatives 
  )->canary_BMA_df #Store in new dataframe
test_final <- rownames_to_column(final,var="index") #Adding id to new data
test_interval <- rownames_to_column(canary_BMA_df,var="index") #Adding id to predictions
test_canary<- test_final %>%
  left_join(test_interval,by="index") #Joining predictions with more info
```

```{r predictions summary, include=FALSE}
#Count how many trees we have of each
test_date%>%
  summarise(sum=ceiling(sum(date)),
            sum_2017=ceiling(sum(date)))->sum_date
test_canary%>%
  summarise(sum=ceiling(sum(canary)),
            sum_2017=ceiling(sum(canary)))->sum_canary
```

```{r prediction plots, include=FALSE}
date_mean <- ggplot(test_date, aes(
 x = distance,
  y = date,
color = cut(indu, breaks = 4))) +
  geom_jitter(alpha=0.5) +
  geom_text(
    aes(x = test_date$distance, y = test_date$date),
    label = test_date$Nom,
    size = 5,
    check_overlap = TRUE,
    inherit.aes = FALSE,
    hjust = 0,
    nudge_x = 0.005
  ) +
  theme_classic() +
  guides(
      color=guide_legend(title = "Industry contribution to GDP (%)")
  ) +
  labs(
    title= paste("Date palm trees 2017,","n =",sum_date$sum_2017,sep = " "),
   subtitle = "Vs. distance and Industry contribution to GDP (%)",
    x = "",
    y = "Date palms"
  )+
  theme(text = element_text(size=20))+
  coord_cartesian(ylim = c(0, 100))
  
ggsave(
  "Date_palms.png",
  width = 7,
  height = 8,
  bg = "transparent"
)

canary_mean <- ggplot(test_canary, aes(
  x = distance,
  y = canary,
color = cut(indu, breaks = 4),
  size = population)
) +
  geom_jitter(alpha=0.5) +
  geom_text(
    aes(x = test_canary$distance, y = test_canary$canary),
    label = test_canary$Nom,
    size = 5,
    check_overlap = TRUE,
    inherit.aes = FALSE,
    hjust = 0,
    nudge_x = 0.005
  ) +
  theme_classic() +
  guides(
    size= guide_legend(title="Population"),
  color=guide_legend(title = "Industry contribution to GDP (%)")
  ) +
  labs(
    title = paste("Canary palm trees 2017,","n =",sum_canary$sum_2017,sep = " "),
    subtitle = "Vs. distance, population, and Industry contribution to GDP (%)",
    x = "Distance to coastline (km)",
    y = "Canary palms"
  )+ theme(text = element_text(size=20))+
  coord_cartesian(ylim = c(0, 200))
ggsave(
  "canary_palms.png",
  width = 7,
  height = 8,
  bg = "transparent"
)

predictions <- arrangeGrob(date_mean,canary_mean,nrow=2)
ggsave("predictions.png",predictions,width = 14,height=16,limitsize = FALSE,bg="transparent")
```

Using these models, we estimated the number of healthy date and canary palms in Catalonia. Estimations appear in Figure \ref{fig:predictions} as a function of distance, population, and industry contribution to GDP (%). We can see that for most municipalities, canary palm trees are located closest to the coast, have a positive relationship with population and negative relationship with industry contribution to GDP (%). The same applies for data palm trees without the relationship with population. 

\begin{figure}[!htb] 
\centerline{\includegraphics[width=30pc]{predictions.png}} 
\caption{Healthy palm tree estimations in 2017. The upper plot shows date species estimations and the lower canary. Both estimations are plotted against distance to the coastline. Since industry contribution to GDP (\%) was a significant estimator for both species, it has been included with colour. This helps us see that municipalities with a lower industry contribution to GDP (\%) have more palm trees than those with a higher industry contribution to GDP (\%). Overall, there are more date than canary trees. In both cases distance to the coastline has an inverse relationship with palm tree occurence.}
\label{fig:predictions} 
\end{figure}

Finally, recall that these estimates correspond to 2017 estimates. To obtain 2005 estimates, we added the reported loss for date (14) and canary palms (8946) provided by GENCAT. Final estimates for date and canary palms were `r sum_date$sum_2017+14` and `r sum_canary$sum_2017+8946`. 

\subsubsection{Infested tree stock in 2005}


<!-- We first define the simulation time constraints and store it in a simulation vector simtime. -->
```{r init model, include=FALSE}
START <- 2005
FINISH <- 2017
YEARS <- FINISH-START+1
STEP <- 1
simtime <- seq(START,FINISH,by=STEP) #simulation time vector
min_trees <- 0 #Min replanting
max_trees <- 100L #Max replanting 
s_Heal <- 19500L
s_Inf <- 500L
p_tau <- 0.5
```

<!-- Now, we define the stocks along with their initial values.  -->
<!-- sHeal stands for healthy trees. -->
<!-- sInf, infested trees. -->
<!-- sTre, for treated trees.  -->

```{r stocks, include=FALSE}
stocks<- c(sHeal=s_Heal, #healthy trees
           sInf=s_Inf, #infested trees
           sTre=0L #treated trees
           )
```

<!-- We now define the auxiliary variables: -->
<!-- aProb_arrival: Probability of arrival of RPW in year t.  -->
<!-- aInsfreq: Inspection frequency. -->
<!-- aTau_prob: Treatment probability. -->
<!-- aSigma_prob: Probability of succesful treatment. -->

```{r auxs, include=FALSE}
auxs <- c(
  aTau_prob = 0.8, # Treatment probability
  aSigma_prob = 0.2, #Probability of succesful treatment
  aDelay=1, #Number of years to recover from an infestation
  aEffective_Contact_Rate= 2 #Number of weevils a palm tree is exposed to per year (weevils/tree/year)
)
```

<!-- The model is a function that will take three parameters. -->

```{r model, include=FALSE }

set.seed(123)
model <-
  function(time, stocks, auxs) {
    #Three parameters for the model.
    with(as.list(c(stocks, auxs)),
         {
           #Set stocks and auxs are defined as lists.
           
           aTotal_Population <-
             sInf + sTre + sHeal #Set the total population as a sum of all three stocks.
           aBeta <-
             aEffective_Contact_Rate / aTotal_Population #Set the beta as the effective contact rate divided by the total population.
           aLambda <- aBeta * sInf
           aAffected <-  sInf + sTre
           fReplanting <- round(runif(1, min = min_trees, max = max_trees), 0) #Generate a random uniform.
           fFail_prev <-round(aLambda * sHeal,0)#Define the failed prevention flow.
           fTreat <- round(sInf * aTau_prob,0)#Define the treated flow.
           fUntreat <- round(sInf * (1 - aTau_prob),0)#Define untreated flow.
           fFail_treat <-round(sTre * (1 - aSigma_prob),0) #Define the unsuccessful treatment flow.
           fSucc_treat <-round(sTre * aSigma_prob / aDelay,0) #Define the successfuul treatment flow.
           
           dH_dt <-
             fReplanting - fFail_prev + fSucc_treat #Define the netflow for stock healthy trees.
           dI_dt <-
             fFail_prev - fTreat - fUntreat #Define the netflow for stock infested trees.
           dTr_dt <-
             fTreat - fSucc_treat - fFail_treat #Define the netflow for stock treated trees.
        
           
           return (
             list(
               c(dH_dt, dI_dt, dTr_dt),
               ForceOfInfestation = aLambda,
               Treated_prob = aTau_prob,
               Success_prob = aSigma_prob,
               #Beta=aBeta,
               Treated = fTreat,
               Untreated = fUntreat,
               Failed_treatment = fFail_treat,
               Successful_treatment = fSucc_treat,
               Replanting = fReplanting,
               Total_population = aTotal_Population,
               Failed_prevention = fFail_prev,
               Affected = aAffected
             )
           )
         })
  }
o <- data.frame(ode(
  y = stocks,
  times = simtime,
  func = model,
  parms = auxs,
  method = "euler"
))#Defining integration method.
o$time <- as.integer(o$time)
o$Treated <- as.integer(o$Treated)
o$Untreated <- as.integer(o$Untreated)
o$Failed_treatment <- as.integer(o$Failed_treatment)
o$sHeal <- as.integer(o$sHeal)
o$sInf <- as.integer(o$sInf)
o$sTre <- as.integer(o$sTre)
o$Successful_treatment <- as.integer(o$Successful_treatment)
o$Total_population <- as.integer(o$Total_population)
o$Failed_prevention <- as.integer(o$Failed_prevention)
```

```{r date simulation, include=FALSE}
#Date palms model
options(scipen = 999)
CE.MIN <- 0.5
CE.MAX <- 2
tau.MIN <- 0.5
tau.MAX <- 1
sigma.MIN <- 0.01
sigma.MAX <- 0.5
sH_2005.MIN <- sum_date$sum_2017+14
sH_2005.MAX <- sum_date$sum_2017+14
sI_2005.MIN <- 1
sI_2005.MAX <- 5


parRange <- data.frame(
  min = c(CE.MIN, tau.MIN, sigma.MIN, sH_2005.MIN, sI_2005.MIN),
  max = c(CE.MAX, tau.MAX, sigma.MAX, sH_2005.MAX, sI_2005.MAX)
)

rownames(parRange) <-
  c(
    "aEffective_Contact_Rate",
    "aTau_prob",
    "aSigma_prob",
    "initHealthy",
    "initInfested"
  )


set.seed(123)
p <- data.frame(Latinhyper(parRange, 5))
g.simRuns <- list()


sensRun <- function(p) {
  g.simRuns <<- list(length = nrow(p))
  
  for (i in 1:nrow(p)) {
    initHealthy <- p [i, "initHealthy"]
    initInfested <- p [i, "initInfested"]
    auxs <- c(aDelay = 1, p[i, 1:5])
    stocks <-
      c(sHeal = initHealthy - initInfested,
        sInf = initInfested,
        sTre = 0)
    o <-
      data.frame(ode(
        y = stocks,
        simtime,
        func = model,
        parms = auxs,
        method = "euler"
      ))
    o$run <- i
    g.simRuns[[i]] <<- o
  }
}

p <- data.frame(Latinhyper(parRange, 4))
sensRun(p)
df_date <- rbind.fill(g.simRuns)

df_date %>%
mutate_at(ceiling,.vars=c("sHeal",
                         "sInf",
                        "sTre",
                        "Treated",
                        "Untreated",
                        "Failed_treatment",
                        "Successful_treatment")) -> df_date
 


```

```{r canary simulation, include=FALSE}
#Canary palms model
options(scipen = 999)
CE.MIN <- 1
CE.MAX <- 2
tau.MIN <- 0.5
tau.MAX <- 1
sigma.MIN <- 0.01
sigma.MAX <- 0.5
sH_2005.MIN <- sum_canary$sum_2017+8946
sH_2005.MAX <- sum_canary$sum_2017+8946
sI_2005.MIN <- 100
sI_2005.MAX <- 1000

parRange <- data.frame(
  min = c(CE.MIN, tau.MIN, sigma.MIN, sH_2005.MIN, sI_2005.MIN),
  max = c(CE.MAX, tau.MAX, sigma.MAX, sH_2005.MAX, sI_2005.MAX)
)

rownames(parRange) <-
  c(
    "aEffective_Contact_Rate",
    "aTau_prob",
    "aSigma_prob",
    "initHealthy",
    "initInfested"
  )


set.seed(123)
p <- data.frame(Latinhyper(parRange, 5))
g.simRuns <- list()


sensRun <- function(p) {
  g.simRuns <<- list(length = nrow(p))
  
  for (i in 1:nrow(p)) {
    initHealthy <- p [i, "initHealthy"]
    initInfested <- p [i, "initInfested"]
    auxs <- c(aDelay = 1, p[i, 1:5])
    stocks <-
      c(sHeal = initHealthy - initInfested,
        sInf = initInfested,
        sTre = 0)
    o <-
      data.frame(ode(
        y = stocks,
        simtime,
        func = model,
        parms = auxs,
        method = "euler"
      ))
    o$run <- i
    g.simRuns[[i]] <<- o
  }
}

p <- data.frame(Latinhyper(parRange, 4))
sensRun(p)
df_canary <- rbind.fill(g.simRuns)

df_canary %>%
mutate_at(ceiling,.vars=c("sHeal",
                         "sInf",
                        "sTre",
                        "Treated",
                        "Untreated",
                        "Failed_treatment",
                        "Successful_treatment")) -> df_canary
```



```{r simulations date plots, include=FALSE}
#Creating breaks for years
int_breaks <-
  function(x, n = 13)
    pretty(x, n)[pretty(x, n) %% 1 == 0]

#Simulations date
healthy_sim <- ggplot(df_date,aes(x=time,
                                    y=sHeal,
                                    group=run,
                                    fill=run,
                                    color=run))+
  geom_area(
    position = "dodge",
    alpha=0.5,linetype="dashed",size=1)+
  ylab("Healthy")+
  xlab("Time") +theme_classic()+
  scale_fill_viridis_c()+
  scale_color_viridis_c()+
  scale_x_continuous(breaks = int_breaks)+
  guides(color=FALSE,
         fill = guide_legend(title = "Run"))+
  labs(
    title = "Healthy date palms",
    x = "Time",
    y = "Date palms"
  )+theme(legend.position = "top")


early_date <- read.xlsx("early.xlsx",sheet = 3)
early_date$year <- as.double(early_date$year)
jesus_line <- ggplot(early_date,aes(x=year,y=Trees,group=Classification))+
  geom_line(color="red",
            size=1)

infested_sim <- ggplot(df_date,aes(x=time,
                                     y=sInf,
                                     fill=run,
                                     group=run,
                                     color=run))+
  geom_area(
    position = "dodge",
    alpha=0.5,linetype="dashed",size=1)+
  ylab("Infested")+
  xlab("Time") +
  theme_classic()+
  scale_fill_viridis_c()+
  scale_color_viridis_c()+
  geom_line(data=early_date,
            aes(x=year,
                y=Trees,
                group=Classification),
            color="red",
            inherit.aes = F,
            size=2,
            alpha=0.5)+
  scale_x_continuous(breaks = int_breaks)+
  guides(color=FALSE,
         fill = guide_legend(title = "Run"))+
  labs(
    title = "Infested date palms",
    subtitle = "Red line represents reported volume of infested palms.",
    x = "Time",
    y = "Date palms"
  )+theme(legend.position = "top")

treated_sim <- ggplot(df_date,aes(x=time,
                                    y=sTre,
                                    fill=run,
                                    group=run,
                                    color=run))+
  geom_area(
    position = "dodge",
    alpha=0.5,
    linetype="dashed",
    size=1)+
  ylab("Treated")+
  xlab("Time")  +
  theme_classic()+
  scale_fill_viridis_c()+
  scale_color_viridis_c()+
  scale_x_continuous(breaks = int_breaks)+
  guides(color=FALSE,
         fill = guide_legend(title = "Run"))+
  labs(
    title = "Date palms under treatment",
    x = "Time",
    y = "Date palms"
  )+theme(legend.position = "top")

simulations_date<- arrangeGrob(healthy_sim,infested_sim,treated_sim, nrow=1)
ggsave("simulations_date.png",simulations_date,width = 14,height=8,limitsize = FALSE,bg="transparent")

```

```{r simulations canary plots, include=FALSE}
#Simulations canary
healthy_sim <- ggplot(df_canary,aes(x=time,
                                    y=sHeal,
                                    group=run,
                                    fill=run,
                                    color=run))+
    geom_area(
            position = "dodge",
            alpha=0.5,linetype="dashed",size=1)+
  ylab("Healthy")+
  xlab("Time") +theme_classic()+
  scale_fill_viridis_c()+
  scale_color_viridis_c()+
  scale_x_continuous(breaks = int_breaks)+
  guides(color=FALSE,
           fill = guide_legend(title = "Run"))+
  labs(
    title = "Healthy canary palms",
    x = "Time",
    y = "Canary palms"
  )+theme(legend.position = "top")


early_canary <- read.xlsx("early.xlsx",sheet = 2)
early_canary$year <- as.double(early_canary$year)
jesus_line <- ggplot(early_canary,aes(x=year,y=Trees,group=Classification))+
  geom_line(color="red",
            size=1)

infested_sim <- ggplot(df_canary,aes(x=time,
                                     y=sInf,
                                     fill=run,
                                     group=run,
                                     color=run))+
   geom_area(
            position = "dodge",
            alpha=0.5,linetype="dashed",size=1)+
  ylab("Infested")+
  xlab("Time") +
  theme_classic()+
  scale_fill_viridis_c()+
    scale_color_viridis_c()+
  geom_line(data=early_canary,
            aes(x=year,
                y=Trees,
                group=Classification),
            color="red",
            inherit.aes = F,
            size=2,
            alpha=0.5)+
  scale_x_continuous(breaks = int_breaks)+
   guides(color=FALSE,
           fill = guide_legend(title = "Run"))+
  labs(
    title = "Infested Canary palms",
    subtitle = "Red line represents reported volume of infested palms.",
    x = "Time",
    y = "Canary palms"
  )+theme(legend.position = "top")

treated_sim <- ggplot(df_canary,aes(x=time,
                                    y=sTre,
                                    fill=run,
                                    group=run,
                                    color=run))+
   geom_area(
            position = "dodge",
            alpha=0.5,
            linetype="dashed",
            size=1)+
  ylab("Treated")+
  xlab("Time")  +
  theme_classic()+
  scale_fill_viridis_c()+
  scale_color_viridis_c()+
  scale_x_continuous(breaks = int_breaks)+
   guides(color=FALSE,
           fill = guide_legend(title = "Run"))+
  labs(
    title = "Canary palms under treatment",
    x = "Time",
    y = "Canary palms"
  )+theme(legend.position = "top")

simulations_canary<- arrangeGrob(healthy_sim,infested_sim,treated_sim, nrow=1)
ggsave("simulations_canary.png",simulations_canary,width = 14,height=8,limitsize = FALSE,bg="transparent")
```

```{r combine simulation plots, include=FALSE}
simulations_combined<- arrangeGrob(simulations_date,simulations_canary, nrow=2)
ggsave("simulations_combined.png",simulations_combined,width = 14,height=8,limitsize = FALSE,bg="transparent")
```

To initialise our model, we needed to estimate the number of infested trees at the beginning of the epidemic (2005). Since no information was available, we tried to estimate this initialisation value by running several simulations of the model whilst varying the initial infested stock. As reference, we used reports for infested stock per year. If the simulation contained the reported infested stock, then it is likely the initialisation parameters are appropriate. To run the simulations, we used Latin Hypercube Sampling (LHS) [@mckayComparisonThreeMethods1979a] implemented with the R FME package [@soetaertSolvingDifferentialEquations2010]. The reports are government (GENCAT) records collected to monitor the evolution of the pest between 2005 and 2014. According to interviews with GENCAT officials, these were collected through non-systematic communications with stakeholders. For example, private owners or municipalities would contact GENCAT and report any noticeable palm tree changes. This is to say that these reports do not accurately reflect the RPW's spatio-temporal infestation pattern, but rather, they provide a minimum volume of affected palm trees per species. Four simulations with random values for each parameter are presented in Figure \ref{fig:simulations}. 

\begin{figure}[!htb]
\centerline{\includegraphics[width=30pc]{simulations_combined.png}}
\caption{Four simulations of healthy, infested and treated stocks with different parameters and initalisation values. The upper plots correspond to date palms while the lower ones to canary palms. The main difference between the two species is that date species decline is less severe than canary decline. This difference is based on the preference the RPW has for it. The red line appearing in the infested palms stock, corresponds to reports provided by GENCAT and collected over the course of the epidemic from municipalities and private palm tree owners. From the simulations, it appears simulations three (green) and four (yellow), are the best fit as they contain reports (red line).}
\label{fig:simulations} 
\end{figure}

Based on the infested stock for canary palms, we note that simulation four (yellow), best fits the reports up to 2008 (red line). Afterwards, there is a decline in reports, including a sharp decline in 2011. We infer this is due to reporting methods and not to a sudden change in the actual patterns of infestation. This inference supported by reports from the subsequent year (2012), where an increase falls within simulation three (green). From these observations, we assume appropiate initialisation parameters for infested stock are between those of simulations three and four, which correspond to values between [3-5] for date palms and [365-975] for canary palms. These selected intialisation values are summarised along with other parameters in Table \ref{tab:initpar}. These will be used for our cost calculations. 

```{r ranges for infested stock 2005, eval=FALSE,include=FALSE}
df_canary%>%
  filter(run==3)%>%
  glimpse()
df_canary%>%
  filter(run==4)%>%
  glimpse()
#3 is run 4 - 5 is run   3 for date palms 

#365 is run 4 - 975 is run 3 for canary palms

#Filter the datasets for both species

df_date%>%
  filter(run==3|run==4)->df_date
df_canary%>%
  filter(run==3|run==4)->df_canary
```

```{r initpar, echo=FALSE}
#Canary palms model
options(scipen = 999)

Values <- c("Effective Contact Rate", 
                              "Treatment prob ($\\tau$)", 
                              "Successful treatment prob ($\\sigma$)", 
                              "Healthy stock 2005",
                              "Infested stock 2005")
Date <- c("[1, 2]","[0.5, 1]","[0.0-0.5]",(sum_date$sum_2017+14),"[3-5]")
Canary <- c("[1, 2]","[0.5, 1]","[0.0-0.5]",(sum_canary$sum_2017+8946),"[365-975]")
parameter_table <- data_frame(Values,Date,Canary)

kable(parameter_table, 
    booktabs = T, 
    caption = "Initialisation and parameter values for both species.", 
    escape = FALSE) %>% 
    kable_styling(latex_options = c("hold_position"), 
        full_width = F)


```

Finally, unitary costs along with their frequencies are summarised in Table \ref{tab:unitary_costs}.
```{r unitary_costs, echo=FALSE}

Type <- as.vector(c("$c^{inspect}$",
                  "$c^{prevent}$",
                  "$c^{treat}$",
                  "$c_t^{replant}$",
                  "$c_t^{removal}$"))

`Value €`  <- as.vector(c(10,20,30,500,500))
`Yearly frequency` <- as.vector(c(2,2,5,1,1))
unit_costs <- data_frame(Type,`Value €` ,`Yearly frequency`)

kable(unit_costs,
    caption = "Unitary costs for management activities.", 
    booktabs = T,
    escape = F) %>% 
    kable_styling(latex_options = c("hold_position"))
```


4.1 Costs
============

```{r exchange rates and money params, echo=FALSE,include=FALSE}
options(digits = 3)
discount_rate <- 0.05
inflation_rate <- 0.02
real_rate <- (1+discount_rate)/(1+inflation_rate)-1


USD <-  as.vector(c(12,125))
Date <- as.vector(c(2007,2014))
exchange_rate_eur <- 0.87 #quantmod::getQuote("USDEUR=X")
EUR <- USD*exchange_rate_eur #$Last
```

```{r future value function, include=FALSE,echo=FALSE}

future_value <- function(pv,real_rate,periods){

pv*(1+real_rate)^periods

}

```

Costs include government (GENCAT) and management costs paid by municipalities and private palm tree owners (Eq. \ref{eq:management_costs}). Data on GENCAT costs were reported by GENCAT as a lump sum and are presented as such. Figure \ref{fig:gencat_plot} (Appendix C) illustrates GENCAT costs brought to present value. Costs start rising from 2005 onwards, peak in 2009 and decline around 2014. This is due to the transfer of costs to municipalities and private owners in 2011. Before 2011, research, outreach and management costs (with the exception of replanting) were contained in GENCAT costs, these are summarised in Appendix C (Table \ref{tab:gencat_table}) and brought to present value with a discount rate of `r discount_rate` and inflation rate of `r inflation_rate`. After 2011, private owners and municipalties assume management costs and continue paying for replanting.

```{r gencat costs, include=FALSE}
#Add GENCAT costs. 
gov_cost <-
  c(
    30000,
    100000,
    500000,
    600000,
    1350000,
    1200000,
    475000,
    203820,
    185232,
    215110,
    140000,
    10545.15,
    8857.20
  ) 

time <- 2005:2017

gov_cost_present <- future_value(gov_cost,real_rate=real_rate,periods = (year(Sys.Date())-time))

gencat <- data_frame(time,gov_cost,gov_cost_present)

```

```{r gencast costs plots, include=FALSE}
gencat %>%
  dplyr::select(time,gov_cost_present)%>%
  gather(key="cost",
         value="amount",
         2)%>%
  ggplot(aes(x=time,
             y=amount,
             color=cost))+
  geom_area(aes(fill=cost),
            position = "dodge",
            alpha=0.5,linetype="dashed",size=1)+
  theme_classic()+
  scale_x_continuous(breaks = int_breaks)+
  guides( color = FALSE,
           fill = FALSE)+
  labs(
    title = "GENCAT costs",
    x = "Time",
    y = "Euros"
  ) + theme(legend.position = "top",
        text = element_text(size=20)) -> gencat_plot

ggsave("gencat_plot.png",gencat_plot,width = 14,height=8,limitsize = FALSE,bg="transparent")
```

We now report costs per species and management category brought to present value. We include a lower and upper bound derived from Table \ref{tab:initpar}. Equation \ref{eq:management_costs} was applied to the lower and upper bound tree estimates. Tables \ref{tab:date_costs_low}, \ref{tab:date_costs_high}, \ref{tab:canary_costs_low} and \ref{tab:canary_costs_high} in Appendix C summarise each activity along with a total for management costs. Table captions summarise the all year total. To illustrate each management category, Figures \ref{fig:date_costs} and \ref{fig:canary_costs} (Appendix C) present this cost breakdown. For date palms, the costliest management activities were inspection and prevention, which makes sense since infestations for this species have been less reported. For canary palms, removal of infested trees has been the most expensive activity. This is consistent with the decline of trees and the high removal cost per tree. Table \ref{tab:total_costs} (Appendix C) summarises lower and upper bounds for each species and total costs (Figure \ref{fig:costs_combined_total} in Appendix C). The lower bound has a less steep decline than the upper bound, canary costs are higher than date costs for all years and it seems that from 2017 onwards, date costs overtake canary costs. In the upper bound where canary decline is stronger, costs are initially high but due to a reduction in overall stock, there is a decline of treatment and removal costs.

```{r Management costs for date palms, include=FALSE}
#Management costs for date palms
unit_replanting <- 500 #Define the unitary cost of replanting (euros)
inspection_cost <- 10 #Define the unitary cost of an inspection (dimensionless)
prevention_cost <- 20 #Define the unitary cost of a prevention (dimensionless)
treatment_cost <- 30
removal_cost <- 500
inspection_freq <- 2 #Define the number of inspections done per year
prevention_freq <- 2 #Define the number of preventative treatments done per year
treatment_freq <- 5 #Define the number of treatments per year
#Equations

df_date %>%
  #Define the replanting cost vector. 
  mutate(rep_cost = ifelse(time>=2011, Replanting * unit_replanting,0),  
         #Calculate annual inspection costs.
         ins_cost = ifelse(time>=2011, sHeal * inspection_freq * inspection_cost,0),
         #Calculate annual prevention costs.
           pre_cost = ifelse(time>=2011, sHeal * prevention_freq * prevention_cost,0),
         #Calculate annual treatment costs
        tre_cost = ifelse(time>=2011, Failed_prevention* treatment_freq * treatment_cost,0),
        #Calculate annual removal costs.
        rem_cost = ifelse(time>=2011, (Failed_treatment+Untreated)*removal_cost,0)) %>%
  dplyr::select(run,
         time,
         rep_cost,
         ins_cost,
         pre_cost,
         tre_cost,
         rem_cost
         )-> date_costs #Calculate total management costs.
```

```{r date_costs present value,echo=FALSE}
low_run=3
date_costs%>%
  filter(run==low_run,
         time>=2011)%>%
  #Bring to present value
  mutate(rep_cost_low=future_value(rep_cost,
                                    real_rate = real_rate,
                                    periods = (year(Sys.Date())-time)),
         ins_cost_low=future_value(ins_cost,
                                    real_rate = real_rate,
                                    periods = (year(Sys.Date())-time)),
         pre_cost_low=future_value(pre_cost,
                                    real_rate = real_rate,
                                    periods = (year(Sys.Date())-time)),
         tre_cost_low=future_value(tre_cost,
                                    real_rate = real_rate,
                                    periods = (year(Sys.Date())-time)),
         rem_cost_low=future_value(rem_cost,
                                    real_rate = real_rate,
                                    periods = (year(Sys.Date())-time)),
         total=c(rep_cost_low+
                   ins_cost_low+
                   pre_cost_low+
                   tre_cost_low+
                   rem_cost_low))%>%
  dplyr::select(time,
                rep_cost_low,
                ins_cost_low,
                pre_cost_low,
                tre_cost_low,
                rem_cost_low,
                total)->date_cost_low


high_run=4
date_costs%>%
  filter(run==high_run,
         time>=2011)%>%
  #Bring to present value
  mutate(rep_cost_high=future_value(rep_cost,
                                   real_rate = real_rate,
                                   periods = (year(Sys.Date())-time)),
         ins_cost_high=future_value(ins_cost,
                                   real_rate = real_rate,
                                   periods = (year(Sys.Date())-time)),
         pre_cost_high=future_value(pre_cost,
                                   real_rate = real_rate,
                                   periods = (year(Sys.Date())-time)),
         tre_cost_high=future_value(tre_cost,
                                   real_rate = real_rate,
                                   periods = (year(Sys.Date())-time)),
         rem_cost_high=future_value(rem_cost,
                                   real_rate = real_rate,
                                   periods = (year(Sys.Date())-time)),
         total=c(rep_cost_high+
                ins_cost_high+
                pre_cost_high+
                tre_cost_high+
                rem_cost_high))%>%
  dplyr::select(time,
                rep_cost_high,
                ins_cost_high,
                pre_cost_high,
                tre_cost_high,
                rem_cost_high,
                total)->date_cost_high


```
         
```{r date costs plots, include=FALSE}

date_cost_low%>%
  gather(key = "cost",value="amount",2:6)%>%
  ggplot(
    aes(x=time,
        y=amount,
        color=cost))+
  geom_area(aes(fill=cost),
            position = "dodge",
            alpha=0.5,linetype="dashed",size=1)+
  theme_classic()+
  scale_color_viridis_d()+
  scale_fill_viridis_d()+
  scale_x_continuous(breaks = int_breaks)+
  guides( color = FALSE,
          fill = guide_legend(title = "Cost type"))+
  labs(
    title = "Date palm costs lower bound",
    x = "Time",
    y = "Euros")+
  theme(legend.position = "top",
        text = element_text(size=20)) -> date_1

#Filter for run 6
date_cost_high%>%
  gather(key = "cost",value="amount",2:6)%>%
  ggplot(
    aes(x=time,
        y=amount,
        color=cost))+
  geom_area(aes(fill=cost),
            position = "dodge",
            alpha=0.5,linetype="dashed",size=1)+
  theme_classic()+
  scale_color_viridis_d()+
  scale_fill_viridis_d()+
  scale_x_continuous(breaks = int_breaks)+
  guides( color = FALSE,
          fill = guide_legend(title = "Cost type"))+
  labs(
    title = "Date palm costs upper bound",
    x = "Time",
    y = "Euros")  + 
  theme(legend.position = "top",
        text = element_text(size=20))-> date_6


date_costs_plots<- arrangeGrob(date_1,date_6,nrow=2)
ggsave("date_costs.png",date_costs_plots,width = 14,height=16,limitsize = FALSE,bg="transparent")
```

```{r Management costs for canary palms, include=FALSE}
#Management costs for canary palms

#Equations
df_canary %>%
    #Define the replanting cost vector. 
  mutate(rep_cost = ifelse(time>=2011, Replanting * unit_replanting,0),  
         #Calculate annual inspection costs.
         ins_cost = ifelse(time>=2011, sHeal * inspection_freq * inspection_cost,0),
         #Calculate annual prevention costs.
           pre_cost = ifelse(time>=2011, sHeal * prevention_freq * prevention_cost,0),
         #Calculate annual treatment costs
        tre_cost = ifelse(time>=2011, Failed_prevention* treatment_freq * treatment_cost,0),
        #Calculate annual removal costs.
        rem_cost = ifelse(time>=2011, (Failed_treatment+Untreated)*removal_cost,0)) %>%
  dplyr::select(run,
         time,
         rep_cost,
         ins_cost,
         pre_cost,
         tre_cost,
         rem_cost
  )-> canary_costs #Calculate total management costs.
```

```{r canary_costs present value,echo=FALSE}

canary_costs%>%
  filter(run==3,
         time>=2011)%>%
  #Bring to present value
  mutate(rep_cost_low=future_value(rep_cost,
                                   real_rate = real_rate,
                                   periods = (year(Sys.Date())-time)),
         ins_cost_low=future_value(ins_cost,
                                   real_rate = real_rate,
                                   periods = (year(Sys.Date())-time)),
         pre_cost_low=future_value(pre_cost,
                                   real_rate = real_rate,
                                   periods = (year(Sys.Date())-time)),
         tre_cost_low=future_value(tre_cost,
                                   real_rate = real_rate,
                                   periods = (year(Sys.Date())-time)),
         rem_cost_low=future_value(rem_cost,
                                   real_rate = real_rate,
                                   periods = (year(Sys.Date())-time)),
         total=c(rep_cost_low+
                   ins_cost_low+
                   pre_cost_low+
                   tre_cost_low+
                   rem_cost_low))%>%
  dplyr::select(time,
                rep_cost_low,
                ins_cost_low,
                pre_cost_low,
                tre_cost_low,
                rem_cost_low,
                total)->canary_cost_low



canary_costs%>%
  filter(run==4,
         time>=2011)%>%
  #Bring to present value
  mutate(rep_cost_high=future_value(rep_cost,
                                    real_rate = real_rate,
                                    periods = (year(Sys.Date())-time)),
         ins_cost_high=future_value(ins_cost,
                                    real_rate = real_rate,
                                    periods = (year(Sys.Date())-time)),
         pre_cost_high=future_value(pre_cost,
                                    real_rate = real_rate,
                                    periods = (year(Sys.Date())-time)),
         tre_cost_high=future_value(tre_cost,
                                    real_rate = real_rate,
                                    periods = (year(Sys.Date())-time)),
         rem_cost_high=future_value(rem_cost,
                                    real_rate = real_rate,
                                    periods = (year(Sys.Date())-time)),
         total=c(rep_cost_high+
                   ins_cost_high+
                   pre_cost_high+
                   tre_cost_high+
                   rem_cost_high))%>%
  dplyr::select(time,
                rep_cost_high,
                ins_cost_high,
                pre_cost_high,
                tre_cost_high,
                rem_cost_high,
                total)->canary_cost_high

```

```{r canary costs plots, include=FALSE}

canary_cost_low%>%
  gather(key = "cost",value="amount",2:6)%>%
  ggplot(
    aes(x=time,
        y=amount,
        color=cost))+
  geom_area(aes(fill=cost),
            position = "dodge",
            alpha=0.5,linetype="dashed",size=1)+
  theme_classic()+
  scale_color_viridis_d()+
  scale_fill_viridis_d()+
  scale_x_continuous(breaks = int_breaks)+
  guides( color = FALSE,
          fill = guide_legend(title = "Cost type"))+
  labs(
    title = "Canary management costs lower bound",
    x = "Time",
    y = "Euros") + theme(legend.position = "top",
        text = element_text(size=20)) -> canary_1

#Filter for run 6
canary_cost_high%>%
  gather(key = "cost",value="amount",2:6)%>%
  ggplot(
    aes(x=time,
        y=amount,
        color=cost))+
  geom_area(aes(fill=cost),
            position = "dodge",
            alpha=0.5,linetype="dashed",size=1)+
  theme_classic()+
  scale_color_viridis_d()+
  scale_fill_viridis_d()+
  scale_x_continuous(breaks = int_breaks)+
  guides( color = FALSE,
          fill = guide_legend(title = "Cost type"))+
  labs(
    title = "Canary management costs upper bound",
    x = "Time",
    y = "Euros"
  ) + theme(legend.position = "top",
        text = element_text(size=20))-> canary_6


canary_costs_plots<- arrangeGrob(canary_1,canary_6,nrow=2)
ggsave("canary_costs.png",canary_costs_plots,width = 14,height=16,limitsize = FALSE,bg="transparent")
```

```{r Create total costs for both species including GENCAT costs, include=FALSE}
#Create total costs for both species including GENCAT costs

date_cost_low_vector <- as.vector(date_cost_low$total)

date_cost_low_vector <- append(date_cost_low_vector,rep(0, 6),after=0)

date_cost_high_vector  <- as.vector(date_cost_high$total)

date_cost_high_vector <- append(date_cost_high_vector,rep(0, 6),after=0)

canary_cost_low_vector  <- as.vector(canary_cost_low$total)

canary_cost_low_vector <- append(canary_cost_low_vector,rep(0, 6),after=0)

canary_cost_high_vector  <- as.vector(canary_cost_high$total)

canary_cost_high_vector <- append(canary_cost_high_vector,rep(0, 6),after=0)

total_costs <- data_frame(time,
                          gov_cost_present,
                          date_cost_low_vector,
                          date_cost_high_vector,
                          canary_cost_low_vector,
                          canary_cost_high_vector)
total_costs%>%
  mutate(total_lower =
           gov_cost_present+date_cost_low_vector+canary_cost_low_vector,
         total_upper =
           gov_cost_present+date_cost_high_vector+canary_cost_high_vector)->total_costs
names(total_costs) <- c("time",
                           "gov_cost_present",
                           "lower_date",
                           "upper_date",
                           "lower_canary",
                           "upper_canary",
                        "total_lower",
                        "total_upper")

total_costs <- total_costs%>%
  dplyr::select(time,
                gov_cost_present,
                lower_date,
                lower_canary,
                total_lower,
                upper_date,
                upper_canary,
                total_upper)
```

```{r costs_combined_total plots, include=FALSE}
total_costs %>%
  dplyr::select(time,gov_cost_present,lower_date,lower_canary)%>%
  gather(key="cost",
         value="amount",
         2:4)%>%
  ggplot(aes(x=time,
             y=amount,
             color=cost))+
  geom_area(aes(fill=cost),
            position = "dodge",
            alpha=0.5,linetype="dashed",size=1)+
  theme_classic()+
  scale_x_continuous(breaks = int_breaks)+
  guides( color = FALSE,
           fill = guide_legend(title = "Cost type"))+
  labs(
    title = "Lower bound",
    x = "Time",
    y = "Euros"
  )+theme(legend.position = "top",
          text = element_text(size=20)) -> lower_costs_plot

total_costs %>%
  dplyr::select(time,gov_cost_present,upper_date,upper_canary)%>%
  gather(key="cost", value="amount",2:4)%>%
  ggplot(aes(x=time,
             y=amount,
             color=cost))+
  geom_area(aes(fill=cost),
            position = "dodge",
            alpha=0.5,linetype="dashed",size=1 )+
  theme_classic()+
  scale_x_continuous(breaks = int_breaks)+
  guides( color = FALSE,
           fill = guide_legend(title = "Cost type"))+
  labs(
    title = "Upper bound",
    x = "Time",
    y = "Euros"
  )+theme(legend.position = "top",
          text = element_text(size=20)) -> upper_costs_plot

costs_combined_total<- arrangeGrob(lower_costs_plot,upper_costs_plot, nrow=2)
ggsave("costs_combined_total.png",
       costs_combined_total,
       width = 14,
       height= 16,
       limitsize = FALSE,
       bg="transparent")
```



4.2 Carbon sequestration benefits
============


In order to estimate benefits associated to carbon sequestration, we provide an interval per tonne for the social cost of carbon ($SCC$), to reflect uncertainty about its value. 12 USD was used as the minimum since this was the lowest $SCC$ found [@iawgTechnicalUpdateSocial2016]. Similarly, the maximum was 125 USD [@vandenberghLowerBoundSocial2014], as it was the highest found. These values were converted  from US dollars to euros at an exchange rate `r exchange_rate_eur` and brought to present value with a discount rate of `r discount_rate` and inflation rate of `r inflation_rate`. Table \ref{tab:scc} summarises the original values, publication date, the values converted to euros, and present value.

```{r SCC table, echo=FALSE}
PV <- future_value(USD,real_rate = real_rate,periods = (year(Sys.Date())-Date))
Source <- as.vector(c("IAWG, 2016","van den Bergh \\& Botzen, 2014"))
SCC_table <- data_frame(Source,USD,Date,EUR,PV)

SCC_table%>%
set_names(c("Source","USD","Published date","EUR", "Present value"))%>%
kable(
    caption = "\\label{tab:scc}Social cost of carbon dioxide per tonne.", 
    booktabs = T,
    escape = F) %>% 
    kable_styling(latex_options = c("hold_position"))
```


In our total benefits calculation, we will present ranges using the lowest (USD 12) and highest (USD 125) $SCC$. The lowest bound for each species will be combined with the lowest $SCC$ and the highest bound for each species will be combined with the highest $SCC$. By applying Equation \ref{eq:social_cost} using a value of 0.191 tonnes per year for 1000 trees [@aguaronComparisonMethodsEstimating2012; @citeulike:14040392] we obtain Table \ref{tab:carbon_costs}, which summarises the results from this calculation. Since carbon sequestration values are directly proportional to tree stock, lower and upper bound carbon sequestration estimates vary according to the tree estimation. In the upper estimates, there is a stronger decline over time, this explains the marked difference between 2005 and 2017 values. 

```{r  carbon sequestration benefits, include=FALSE}
#Constants
net_carbon <- 0.000191 #Define the net carbon sequestration capacity per tree (tonnes/tree)
SCC_carbon_upper <-SCC_table$PV[2] #Define the upper social cost of carbon per one tonne (euros)  
SCC_carbon_lower <- SCC_table$PV[1] #Define the upper social cost of carbon per one tonne (euros)  

date_lower <- df_date %>%
  filter(run==low_run)%>%
  mutate(total=sHeal+sInf+sTre)
  
date_upper <- df_date %>%
  filter(run==high_run)%>%
    mutate(total=sHeal+sInf+sTre)

canary_lower <- df_canary %>%
  filter(run==low_run)%>%
    mutate(total=sHeal+sInf+sTre)

canary_upper <- df_canary %>%
  filter(run==high_run)%>% 
  mutate(total=sHeal+sInf+sTre)

carbon_lower_date <- date_lower$total*SCC_carbon_lower*net_carbon
carbon_lower_date <-future_value(carbon_lower_date,
                                 real_rate = real_rate,
                                 periods = (year(Sys.Date())-time))

carbon_upper_date <- date_upper$total*SCC_carbon_upper*net_carbon
carbon_upper_date <-future_value(carbon_upper_date,
                                 real_rate = real_rate,
                                 periods = (year(Sys.Date())-time))

carbon_lower_canary <- canary_lower$total*SCC_carbon_lower*net_carbon
carbon_lower_canary <-future_value(carbon_lower_canary,
                                 real_rate = real_rate,
                                 periods = (year(Sys.Date())-time))

carbon_upper_canary <- canary_upper$total*SCC_carbon_upper*net_carbon
carbon_upper_canary <-future_value(carbon_upper_canary,
                                 real_rate = real_rate,
                                 periods = (year(Sys.Date())-time))


carbon_benefits <- data.frame(time,
                              carbon_lower_date,
                              carbon_upper_date,
                              carbon_lower_canary,
                              carbon_upper_canary)

carbon_benefits <- carbon_benefits%>%
  mutate(total_lower=carbon_lower_date+carbon_lower_canary,
         total_upper=carbon_upper_date+carbon_upper_canary)%>%
  dplyr::select(time,carbon_lower_date,carbon_lower_canary,total_lower,
                carbon_upper_date,carbon_upper_canary,total_upper)
```

4.3 Property values benefits
==========





```{r read-idealista-data, include=FALSE}
idealista <- read.xlsx("idealista_data.xlsx")
#See idealista structure
glimpse(idealista)
#is.numeric returns TRUE if the variable is numeric. 
#sapply iterates and returns a vector. 
#Which gives the indices that were TRUE
num_var <- which(sapply(idealista, is.numeric))
#Count how many variables are numeric
length_num_var <- length(num_var)
#Return a vector with character variables
cat_var <- which(sapply(idealista, is.character))
#Count how many variables are characters
length_car_var <- length(cat_var)

#Change geonames
names(idealista)[names(idealista) == "LEVEL3NAME"] <- "PROVINCE"
names(idealista)[names(idealista) == "LEVEL4NAME"] <- "COMARCA"
names(idealista)[names(idealista) == "LEVEL5NAME"] <- "UNKNOWN"
names(idealista)[names(idealista) == "LEVEL6NAME"] <- "MUNICIPALITY"
```
We now present estimations for benefits derived from palm tree adjacency. To calculate these we used data provided by Idealista S.A., an online marketplace for buying and renting properties in Spain, Portugal, and Italy. An important clarification for this section is that the response variable used for the regression was the asking or listed price for a property. Contrast this to the actual sale price of a property. Actual sale prices for properties in Catalonia were not
possible to obtain, however, we consider using asking price a good proxy for the purposes of this article.

The dataset contained `r nrow(idealista)` observations describing detached properties on sale in Catalonia during October 2018. The properties were distributed evenly amongst Catalonia with at least 50 observations per *comarca*, which we defined earlier as our strata. Upon initial exploration of the dataset, there were 8 numerical and 21 character variables.

The first step was to identify categorical variables within all the character variables. Here, some were identified as categorical and others related to the unique property address were left as character. The second step was to deal with missingness in the data. Most missing values appeared in variables that signalled the presence or absence of a feature (i.e. ~ swimming pool, wardrobe, terrace, garden, etc.). Since these missing values were a case of missing completely at random (MCAR), it was safe to remove observations without introducing bias into the data. However, we wanted to keep as many observations as possible so we performed imputation. After the dataset was complete, we transformed all categorical variables into numerical ones. Ordinal categorical variables were revalued to a scale, and dummies were created for non-ordinal variables. 

Since we were interested in capturing the aesthetic value derived from palm-tree adjacency, two variables were created to count the ocurrence of each species on properties or within their immediate surroundings.


```{r missing values,  include=FALSE, eval=FALSE}
#Which variables have missingness in data
 idealista%>%
   select_if(function (x) any(is.na(x)))%>%
   summarise_all(funs(sum(is.na(.))))%>%
   gather()%>%
   arrange(desc(value))
```

```{r recoding, include=FALSE, eval=FALSE}

#Create boolean vector
boolean_vector <- c("Sí"=1, "No"=0)

#Missingness HASBALCONY
idealista$HASBALCONY[is.na(idealista$HASBALCONY)] <- "No"

#Recode HASBALCONY
idealista$HASBALCONY <-as.integer(plyr::revalue(idealista$HASBALCONY , boolean_vector))

#CONSTRUCTIONYEAR missing values will be replaced by COMARCA median for CONSTRUCTIONYEAR
for (i in 1:nrow(idealista)){
  if(is.na(idealista$CONSTRUCTIONYEAR[i])){
    idealista$CONSTRUCTIONYEAR[i] <-
      as.integer(median(idealista$CONSTRUCTIONYEAR[idealista$COMARCA==idealista$COMARCA[i]],
                        na.rm=TRUE)) 
  }
}

#Missingness HASAIRCONDITIONING
idealista$HASAIRCONDITIONING[is.na(idealista$HASAIRCONDITIONING)] <- "No"

#Recode HASAIRCONDITIONING
idealista$HASAIRCONDITIONING <-as.integer(plyr::revalue(idealista$HASAIRCONDITIONING , boolean_vector))

#Missingness  BUILDINGFLOORS 
idealista$BUILDINGFLOORS [is.na(idealista$ BUILDINGFLOORS )] <- 1

#PLOTOFLAND missing values will be replaced by COMARCA median for PLOTOFLAND
for (i in 1:nrow(idealista)){
  if(is.na(idealista$PLOTOFLAND[i])){
    idealista$PLOTOFLAND[i] <-
      as.integer(median(idealista$PLOTOFLAND[idealista$COMARCA==idealista$COMARCA[i]],
                        na.rm=TRUE)) 
  }
}


#Missingness HASWARDROBE
idealista$HASWARDROBE[is.na(idealista$HASWARDROBE)] <- "No"

#Recode HASWARDROBE
idealista$HASWARDROBE <-as.integer(plyr::revalue(idealista$HASWARDROBE , boolean_vector))

#Missingness HASGARDEN
idealista$HASGARDEN[is.na(idealista$HASGARDEN)] <- "No"

#Recode HASGARDEN
idealista$HASGARDEN <-as.integer(plyr::revalue(idealista$HASGARDEN , boolean_vector))

#Missingness HASSWIMMINGPOOL
idealista$HASSWIMMINGPOOL[is.na(idealista$HASSWIMMINGPOOL)] <- "No"

#Recode HASSWIMMINGPOOL
idealista$HASSWIMMINGPOOL <-as.integer(plyr::revalue(idealista$HASSWIMMINGPOOL , boolean_vector))

#Missingness HASTERRACE
idealista$HASTERRACE[is.na(idealista$HASTERRACE)] <- "No"

#Recode HASTERRACE
idealista$HASTERRACE <-as.integer(plyr::revalue(idealista$HASTERRACE , boolean_vector))


#Missingness HASPARKINGSPACE
idealista$HASPARKINGSPACE[is.na(idealista$HASPARKINGSPACE)] <- "No"

#Recode HASPARKINGSPACE
idealista$HASPARKINGSPACE <-as.integer(plyr::revalue(idealista$HASPARKINGSPACE , boolean_vector))

#Missingness BUILTTYPEID
idealista$BUILTTYPEID[is.na(idealista$BUILTTYPEID)] <- "Unknown"

#Recode BUILTTYPEID
idealista$BUILTTYPEID <- as.factor(idealista$BUILTTYPEID)


idealista <- na.omit(idealista)


#Pad postcode with leading zeroes

idealista$POSTALCODE <- str_pad(idealista$POSTALCODE, width=5, side="left", pad="0")


```


```{r mutate-idealista-dataset, include=FALSE, eval=FALSE}

#Select variables that are factors
cols_factors <- c("PROPERTYTYPEID",
                  "CHALETTYPEID",
                  "BUILTTYPEID",
                  "ENERGYCERTIFICATIONID",
                  "PROVINCE")

#Convert to factors
idealista[cols_factors] <- lapply(idealista[cols_factors], factor)


#Create years since built variable
idealista <- idealista %>%
  #Current year - construction year
  mutate(YEARSBUILT = year(Sys.Date())-CONSTRUCTIONYEAR)

#Create address variable
idealista <- idealista%>%
  mutate(ADDRESS=paste0(CLEANSTREETNAME,
                       ", ",
                       STREETNUMBER,
                       ", ",
                       POSTALCODE,
                       " ",
                       MUNICIPALITY,
                       ", ",
                       UNKNOWN,
                       ", ",
                       COMARCA,
                        ", ",
                       PROVINCE,
                       ", ",
                       "Spain"))


```

```{r arrange dataset, include=FALSE, eval=FALSE}
#Arrange dataset in descending order by comarca and price
idealista <- idealista %>%
        arrange(COMARCA,
                desc(PRICE))
idealista <- idealista%>%
  distinct(... = ADDRESS, .keep_all = TRUE)

```


```{r finding latlon, include=FALSE, eval=FALSE}

# Loop through the addresses to get the latitude and longitude of each address

for(i in 1:nrow(idealista))
{
  # Print("Working...")
  result <- geocode(idealista$ADDRESS[i],
                    output = "latlona",
                    source = "google")
  idealista$LAT[i] <- as.numeric(result[2])
  idealista$LON[i] <- as.numeric(result[1])
  idealista$GEOADDRESS[i] <- as.character(result[3])
}
```

```{r get maps 1, include=FALSE, eval=FALSE}


idealista_1_400 <- idealista$ADDRESS[1:400]

houses_maps_1_400 <- lapply(idealista_1_400,
                      function(x)
                        tryCatch(get_map(location = x,
                                   zoom = 20, 
                                   maptype = "satellite", 
                                   source = "google"),
                                   error = function(e) {
                                   print(e)
                                   return(NA)
                                 }))

indices_remove <- which(is.na(houses_maps_1_400))

houses_maps_1_400 <- houses_maps_1_400[-indices_remove]

#Save houses
saveRDS(houses_maps_1_400,"houses_maps_1_400")

for (i in seq_along(houses_maps_1_400)) {
  filename <-str_c("idealista",i,".png")
  png(filename = filename,width=1000, height=1000) 
m <-ggmap(houses_maps_1_400[[i]]) 
print(m)
dev.off()

}
```

```{r get maps 2, include=FALSE, eval=FALSE}
register_google(key = "AIzaSyAKCGR3vE8h4To_FH6_Nf9CObXLUbVEyNE")
idealista_401_800 <- idealista$ADDRESS[401:800]

houses_maps_401_800 <- lapply(idealista_401_800,
                            function(x)
                              tryCatch(get_map(location = x,
                                               zoom = 20, 
                                               maptype = "satellite", 
                                               source = "google"),
                                       error = function(e) {
                                         print(e)
                                         return(NA)
                                       }))

indices_remove <- which(is.na(houses_maps_401_800))

houses_maps_401_800 <- houses_maps_401_800[-indices_remove]

#Save houses
saveRDS(houses_maps_401_800,"houses_maps_401_800")

#Print images
for (i in seq_along(houses_maps_401_800)) {
  filename <-str_c("idealista",i,".png")
  png(filename = filename,width=1000, height=1000) 
  m <-ggmap(houses_maps_401_800[[i]]) 
  print(m)
  dev.off()
  
}
```

```{r get maps 3, include=FALSE, eval=FALSE}
register_google(key = "AIzaSyAKCGR3vE8h4To_FH6_Nf9CObXLUbVEyNE")
idealista_801_1200 <- idealista$ADDRESS[801:1200]

houses_maps_801_1200 <- lapply(idealista_801_1200,
                            function(x)
                              tryCatch(get_map(location = x,
                                               zoom = 20, 
                                               maptype = "satellite", 
                                               source = "google"),
                                       error = function(e) {
                                         print(e)
                                         return(NA)
                                       }))

indices_remove <- which(is.na(houses_maps_801_1200))

houses_maps_801_1200 <- houses_maps_801_1200[-indices_remove]

#Save houses
saveRDS(houses_maps_801_1200,"houses_maps_801_1200")

#Print images
for (i in seq_along(houses_maps_801_1200)) {
  filename <-str_c("idealista",i,".png")
  png(filename = filename,width=1000, height=1000) 
  m <-ggmap(houses_maps_801_1200[[i]]) 
  print(m)
  dev.off()
  
}
```

```{r get maps 4, include=FALSE, eval=FALSE}

register_google(key = "AIzaSyAKCGR3vE8h4To_FH6_Nf9CObXLUbVEyNE")
idealista_1201_1600 <- idealista$ADDRESS[1201:1600]

houses_maps_1201_1600 <- lapply(idealista_1201_1600,
                               function(x)
                                 tryCatch(get_map(location = x,
                                                  zoom = 20, 
                                                  maptype = "satellite", 
                                                  source = "google"),
                                          error = function(e) {
                                            print(e)
                                            return(NA)
                                          }))

indices_remove <- which(is.na(houses_maps_1201_1600))

houses_maps_1201_1600 <- houses_maps_1201_1600[-indices_remove]

#Save houses
saveRDS(houses_maps_1201_1600,"houses_maps_1201_1600")

#Print images
for (i in seq_along(houses_maps_1201_1600)) {
  filename <-str_c("idealista",i,".png")
  png(filename = filename,width=1000, height=1000) 
  m <-ggmap(houses_maps_1201_1600[[i]]) 
  print(m)
  dev.off()
  
}
```

```{r get maps 5, include=FALSE, eval=FALSE}
register_google(key = "AIzaSyAKCGR3vE8h4To_FH6_Nf9CObXLUbVEyNE")
idealista_1601_1896 <- idealista$ADDRESS[1601:1896]

houses_maps_1601_1896 <- lapply(idealista_1601_1896,
                               function(x)
                                 tryCatch(get_map(location = x,
                                                  zoom = 20, 
                                                  maptype = "satellite", 
                                                  source = "google"),
                                          error = function(e) {
                                            print(e)
                                            return(NA)
                                          }))

indices_remove <- which(is.na(houses_maps_1601_1896))

houses_maps_1601_1896 <- houses_maps_1601_1896[-indices_remove]

#Save houses
saveRDS(houses_maps_1601_1896,"houses_maps_1601_1896")

#Print images
for (i in seq_along(houses_maps_1601_1896)) {
  filename <-str_c("idealista",i,".png")
  png(filename = filename,width=1000, height=1000) 
  m <-ggmap(houses_maps_1601_1896[[i]]) 
  print(m)
  dev.off()
  
}
```

```{r remove unexistent location, include=FALSE, eval=FALSE}

odd_locations <- c("gracia de, 36-40, 17130 L'Escala, L'Escala, Alt Empordà, Girona, Spain",
                   "unio, 31-35, 17490 Llançà, Área de Llançà, Alt Empordà, Girona, Spain",
                   "lleida a puigcerda, 46-50, 25700 La Seu d'Urgell, Área de Alt Urgell - Cerdanya, Alt Urgell, Lleida, Spain",
                   "zinnia, 41-45, 43700 El Vendrell, El Vendrell, Baix Penedès, Tarragona, Spain" 
,"beneficio, 6-10, 25726 Lles, Baixa Cerdanya, Baixa Cerdanya, Lleida, Spain",
"mas munt, 21-25, 17538 Fontanals de Cerdanya, Fontanals-Das-Urús, La Cerdanya, Girona, Spain",
 "mayor, 0-5, 25517 Pallars Jussá, Área de Pallars Jussà, Pallars Jussà, Lleida, Spain", "pallá, 0-5, 43790 Riba-Roja d'Ebre, Área de Flix, Ribera d'Ebre, Tarragona, Spain", "esplai, 36-40, 25001 Lleida, Área de Lleida, Segrià, Lleida, Spain", "mur castell, 0-5, 25353 Tárrega, Área de Tàrrega, Urgell, Lleida, Spain", "francia, 46-50, 25530 Vielha E Mijaran, Área de Vielha, Val d'Aran, Lleida, Spain") 

idealista_1 <- idealista[idealista$ADDRESS %in% idealista_1_400, ]
  
idealista_1 <- idealista_1[!idealista_1$ADDRESS %in% odd_locations, ]

write.xlsx(idealista_1, file = "idealista_1.xlsx")

idealista_2 <- idealista[idealista$ADDRESS %in% idealista_401_800, ]

idealista_2 <- idealista_2[!idealista_2$ADDRESS %in% odd_locations, ]

write.xlsx(idealista_2, file = "idealista_2.xlsx")

idealista_3 <- idealista[idealista$ADDRESS %in% idealista_801_1200, ]

idealista_3 <- idealista_3[!idealista_3$ADDRESS %in% odd_locations, ]

write.xlsx(idealista_3, file = "idealista_3.xlsx")

idealista_4 <- idealista[idealista$ADDRESS %in% idealista_1201_1600, ]

idealista_4 <- idealista_4[!idealista_4$ADDRESS %in% odd_locations, ]

write.xlsx(idealista_4, file = "idealista_4.xlsx")

idealista_5 <- idealista[idealista$ADDRESS %in% idealista_1601_1896, ]

idealista_5 <- idealista_5[!idealista_5$ADDRESS %in% odd_locations, ]

write.xlsx(idealista_5, file = "idealista_5.xlsx")
```

```{r read counts, include=FALSE}

palms_read_1 <- read.xlsx("idealista_1.xlsx")
palms_read_2 <- read.xlsx("idealista_2.xlsx")
palms_read_3 <- read.xlsx("idealista_3.xlsx")
palms_read_4 <- read.xlsx("idealista_4.xlsx")
palms_read_5 <- read.xlsx("idealista_5.xlsx")

palms_read_3$n_date <- as.numeric(palms_read_3$n_date)

idealista_read <- rbind(palms_read_1,
                            palms_read_2,
                            palms_read_3,
                            palms_read_4,
                            palms_read_5)

idealista_read$n_date[is.na(idealista_read$n_date)] <- 0
idealista_read$n_canary[is.na(idealista_read$n_canary)] <- 0

idealista_read <- idealista_read %>%
  dplyr::select(-ADDRESS,
                -PROPERTYCOMMENT,
                -CLEANSTREETNAME,
                -STREETNUMBER,
                -POSTALCODE,
                -UNKNOWN,
                -LEVEL2NAME,
                -ADTYPOLOGYID,
                -PROPERTYTYPEID,
                -ADOPERATIONID,
                -BUILTTYPEID,
                -MUNICIPALITY,
                -ENERGYCERTIFICATIONID)

idealista_factors <- idealista_read %>%
  select_if(is.character)%>%
  mutate_all(as.factor)

idealista_read <- idealista_read%>%
  select_if(is.numeric)%>%
  cbind(idealista_factors)

```

Using the GGMap package for R software [@kahleGgmapSpatialVisualization2013] and each unique property address, individual images were printed. Each image was screened for either date or canary palms. After removing duplicate properties and addresses which were not found on Google, the dataset had `r nrow(idealista_read)` observations.

```{r initial data skim, include=FALSE}
idealista_clean <- idealista_read%>%
  dplyr::select(-COMARCA,
                -PROVINCE,
                -CHALETTYPEID)
skim(idealista_clean)
```

```{r remove_outliers, include=FALSE}
idealista_clean <- idealista_clean%>%
  filter(PRICE<quantile(idealista_read$PRICE, 0.95),
         PLOTOFLAND<quantile(idealista_read$PLOTOFLAND, 0.95),
         CONSTRUCTEDAREA<quantile(idealista_read$CONSTRUCTEDAREA, 0.95),
         BATHNUMBER<quantile(idealista_read$BATHNUMBER, 0.95),
         ROOMNUMBER<quantile(idealista_read$ROOMNUMBER, 0.95),
         BUILDINGFLOORS<quantile(idealista_read$BUILDINGFLOORS, 0.95))
```
Each variable was plotted to look at the distributions. Outliers were removed for several variables since there cases listed as independent homes that likely were not part of the same sample (i.e. independent houses with more than 12 floors). In the case of the response variable, the median price per home was € `r median(idealista_read$PRICE)` and the 95th quantile was € `r quantile(idealista_read$PRICE, 0.95)` but the maximum sales price was € `r max(idealista_read$PRICE)`, which skewed the distribution. A similar procedure was followed for all variables that were not boolean. After removing outliers, the dataset had `r nrow(idealista_clean)` observations and `r length(idealista_clean)` variables included the response varaible. This means we had `r length(idealista_clean)-1` regressors. 

```{r skim clean dataset, include=FALSE}
skim(idealista_clean)
```

```{r initial fit model, include=FALSE}
#Create a model for all variables

fit <- lm(PRICE~ ., data = idealista_clean, na.action = "na.fail")


tidy(anova(fit))%>%
  arrange(p.value)%>%
  filter(p.value<0.05)%>%
  dplyr::select(term, statistic, p.value)
```

```{r choose model, include=FALSE, eval=FALSE}
all_models <- dredge(fit, rank = "BIC")
#Save models
saveRDS(all_models, "all_models")
```

```{r read_models, include=FALSE}
#Read models
all_models <- readRDS("all_models")
nrow(all_models)
```

```{r include=FALSE, eval=FALSE}
girona_clean <- idealista_read%>%
  filter(PROVINCE=="Girona")%>%
  dplyr::select(-COMARCA,
                -CHALETTYPEID,
                -PROVINCE)%>%
  filter(PRICE<1500000,
         PLOTOFLAND<1000,
         CONSTRUCTEDAREA<500,
         BATHNUMBER<10,
         ROOMNUMBER<10,
         BUILDINGFLOORS<5)

fit_girona <- lm(PRICE~  ., data=girona_clean)
```

To determine whether date or canary palms contribute significantly to enhance aesthetic values, we fitted a global model with all regressors. The t-tests for date and canary palms did not produce significant p-values. To select the model that best estimated the price variable, we once again selected the Bayesian information criterion (BIC) as the standard to compare models. We tested all possible models $(2^{16 parameters}=65,536)$ aiming to minimise the BIC. This was implemented with the *dredge()* function of the MuMln package for R software. This function generates a set of models with combinations of fixed effect terms in the global model. The model that minimises the BIC included number of bathrooms, constructed area, constructed year, garden, swimming pool, wardrobe, and plot size as regressors. Overall, we were not able to capture any values associated with palm tree occurrence.

4.4 Total costs and benefits
============

```{r total costs summary, include=FALSE}
total_costs %>%
  mutate(total_lower=gov_cost_present+lower_date+lower_canary,
         total_upper=gov_cost_present+upper_date+upper_canary) -> total_costs

carbon_benefits%>%
  mutate(total_lower=  carbon_lower_date+carbon_lower_canary,
         total_upper=carbon_lower_canary+carbon_upper_canary) -> total_benefits
```

```{r costs and benefits summary, include=FALSE}
cb_lower <- data.frame(time, total_costs$total_lower,total_benefits$total_lower)
names(cb_lower) <- c("time","costs","benefits")
cb_upper <- data.frame(time, total_costs$total_upper,total_benefits$total_lower)
names(cb_upper) <- c("time","costs","benefits")

cb_lower%>%
  summarise(sum(costs),sum(benefits)) ->cb_total_lower

cb_upper%>%
  summarise(sum(costs),sum(benefits))->cb_total_upper
```

```{r cost benefits plotted, include=FALSE}

cb_lower %>%
  mutate(costs=costs/1000)%>%
gather(key = "type",value="amount",2:3)%>%
   ggplot(aes(x=time,
             y=amount,
             color=type))+
  geom_area(aes(fill=type),
            position = "dodge",
            alpha=0.5,linetype="dashed",size=1 )+
  theme_classic()+
  scale_x_continuous(breaks = int_breaks)+
  guides( color = FALSE,
           fill = guide_legend(title = ""))+
   scale_fill_manual(values=c("#00BA38","#F8766D"))+
  scale_color_manual(values=c("#00BA38","#F8766D"))+
  labs(
    title = "Costs vs. benefits (lower bound)",
    subtitle = "Costs were divided by 1,000 to allow benefits to appear in the plot.",
    x = "Time",
    y = "Euros")+
  theme(legend.position = "top")-> cb_lower_plot

cb_upper %>%
  mutate(costs=costs/1000)%>%
gather(key = "type",value="amount",2:3)%>%
   ggplot(aes(x=time,
             y=amount,
             color=type))+
  geom_area(aes(fill=type),
            position = "dodge",
            alpha=0.5,linetype="dashed",size=1 )+
  theme_classic()+
  scale_fill_manual(values=c("#00BA38","#F8766D"))+
  scale_color_manual(values=c("#00BA38","#F8766D"))+
  scale_x_continuous(breaks = int_breaks)+
  guides( color = FALSE,
           fill = guide_legend(title = ""))+
  labs(
    title = "Costs vs. benefits (upper bound)",
    subtitle = "Costs were divided by 1,000 to allow benefits to appear in the plot.",
    x = "Time",
    y = "Euros"
  )+theme(legend.position = "top",
          text=element_text(size=10)) -> cb_upper_plot

cost_benefit_plot<- arrangeGrob(cb_lower_plot,cb_upper_plot, nrow=2)
ggsave("cost_benefit_plot.png",
       cost_benefit_plot,
       width = 8,
       height= 8,
       limitsize = FALSE,
       bg="transparent")
```

We obtained Figure \ref{fig:cost_benefit} by merging total costs and benefits for each bound (lower and upper) in a single plot. The costs include goverment (GENCAT) and management costs paid by municipalities and private owners from 2011 onwards. The benefits associated to carbon sequestration are far exceeded by total costs.

\begin{figure}[!htb]
\centerline{\includegraphics[width=30pc]{cost_benefit_plot.png}}
\caption{Total costs vs. benefits for the RPW policy betweeen 2006 and 2017. Costs include GENCAT and management costs for date and canary trees. Benefits include carbon sequestration. In both instances, benefits derived from palm treesare dwarfed in comparison to the expenditure to preserve them.}
\label{fig:cost_benefit} 
\end{figure}

```{r NSB, echo=FALSE}
nsb_low <- round(sum(carbon_benefits$total_lower)-sum(total_costs$total_lower),digits = 0)
nsb_ratio_low  <- round(sum(total_costs$total_lower)/sum(carbon_benefits$total_lower),digits=0)
nsb_high <- round(sum(carbon_benefits$total_upper)-sum(total_costs$total_upper),digits=0)
nsb_ratio_high <- round(sum(total_costs$total_upper)/sum(carbon_benefits$total_upper),digits=0)
```

As stated earlier, all values presented so far have been brought to present value with the same discount (`r discount_rate`) and inflation (`r inflation_rate`) rates. By applying Equation \ref{eq:nsb} between 2005 and 2017, the net social benefits (NSB) for the lower bound were €`r nsb_low `, in other words, `r nsb_ratio_low` times benefits. For the upper bound, the NSB were €`r nsb_high ` or `r nsb_ratio_high` times the benefits. 

5. Discussion
============

The costs of pest management, eradication and replacement of RPW infested palms were previously estimated for Italy, Spain and France by the FAO. Up to 2013, the combined costs for all three countries were reported at €90 million with an increase of €110 million by 2023 [@faoNewActionPlan2017]. Our cost calculations concur with magnitidue of FAO estimates. We did not, however, find the conservation policy justified based on the analysis presented in this article. 

Countries where a similar cost-benefit analysis could yield results that support a similar policy are, for example, Tunisia and Egypt, where production of date fruits is not insignificant and the RPW is allegedly a major threat [@speakmancordallPanicRedDevils2017]. Another place where this type of conservation policy could be justified is the Canary Islands since canary palms are a native species, unlike in the Iberian Peninsula. When a species is native, conservation efforts from a socio-cultural perspective are more likely to be justified. In these islands, the RPW was reported in 2007 and declared completely eradicated by 2016. Eradication efforts included the inspection of 706,081 palms, of which 209,537 were treated, 659 removed and destroyed, and 681 weevils were caught [@gobiernodecanariasCanariasPrimerTerritorio2016].

The larger mandate that underpins the conservation policy here analysed is 2007/365/CE (see Appendix A). This policy was released for EU member states with susceptible trees stating mandatory measures, including the ones here described as management activities. Within EU publication related to this policy, we could not find an invasion analysis included justifying the EU wide mandate. Prioritisation of budgets for biological invasions should be based on analysis that include species, pathways and sites, and impacts [@mcgeochPrioritizingSpeciesPathways2016]. 

Understandably, an argument against the type of cost-benefit analysis here performed is that social and cultural values are hard to capture and quantify. Granted, non-monetary values are important, as we acknowledged by including the TEV framework. In a world with unlimited resources, conservation of natural assets without any direct or indirect benefits, could be possible. Alas, when dealing with biological insect invasions that affect human health, livelihoods, and threatened species, prioritising the cosliest impacts is necessary.

6. Conclusions
============

In the context of rising biological invasions with costly impacts, determining priority areas is fundamental for optimal budgeting. Several frameworks for prioritising biological invasions have risen in recent years. In this article we assess to what extent these frameworks are being implemented in current policies. To do so, we selected a policy published in response to the arrival of invasive insect to the Iberian Peninsula in the early noughties - the red palm weevil (RPW), a beetle that affects susceptible palm tree varieties. Amongst invasive species, insects are the costliest species. It is estimated that less than half of potential insect invasions have taken place [@seebensGlobalRiseEmerging2018]. To assess the policy, we performed a cost-benefit analysis within the region of Catalonia, Spain. This was done in several steps. First, we interviewed stakeholders from goverment and industry to properly understand all associated costs. Second, we estimated the number of palm trees in the region at the beginning of the infestation and modelled their decline until present. Third, based on the Total Economic Value (TEV) framework we identified two quantifiable benefits derived from palm tree existence: carbon sequestration and enhanced aesthetic value derived from palm-tree adjacency and captured through property prices. Fourth, based on steps two and three, we calculated the costs and benefits associated with the policy. Finally, we computed the net social benefits of the policy. We found that the costs of the policy far outweight the benefits. This is likely due to the almost exclusive ornamental use of palm trees in Catalonia, Spain. 


Acknowledgements
==========

Servei de Sanitat Vegetal de la Generalitat de Catalunya provided interviews, records and further information on the pest in Catalonia. Dr Martí Boada and Dr Jaume Marlès Magre kindly gave feedback on the estimation of the number of palm trees. Joan Freixa Gaspar and Josep Muntaner shared insights on private palm tree owners and their behaviour. Cristian E. Nuno from the University of Chicago Urban Labs provided guidance on calculating distances to the coastline. Idealista S.A. shared the dataset to estimate palm tree adjacency benefits. 


Funding
==========
This research was funded by the Spanish Ministry of Science, Innovation and Universities, through the “María de Maeztu” program for Units of Excellence (MDM-2015-0552).

\newpage

Appendices
==========


Appendix A: Summaries of the policies selected and related legislation
========

This section expands on details related to the policy assessed in this article. It summarises all GENCAT orders and includes the EU legislation that underpins local RPW rules.

-   Order ARP/343/2006: On July 3rd 2006, RPW presence in Catalonia is confirmed. Pest prevention and management is declared of public interest. Costing implications based on articles 8, 9 and 12 include inspection, detection, destruction and indemnification to property owners. The total costs for these activities have been provided by the regional government, which also include survey, research, regulation, management, and outreach costs [@generalitatdecatalunyaOrdreARP3432006]. 

-   2007/365/EC: On 25th May 2007, the EU Commission publishes a decision based on the RPW spread along the Iberian Peninsula. The decision specifies palm tree vulnerability and announces a series of measures to be taken by member countries, including delimitation of areas at RPW risk [@eucomissionComissionDecision252007].

-   2008/776/EC: On 6th October 2008, the previous decision 2007/365/CE is modified by expanding the range of vulnerable palm trees [@eucomission2008776CE2008].

-   Order AAR/226/2009: GENCAT updates Order ARP/343/2006 by redefining and specifying actions to be taken, namely delimitation, inspections, pruning, treatment, and destruction of affected palm trees. This update is based on a decision made by the EU Commission. All costs continue to be borne by the GENCAT [@generalitatdecatalunyaOrdreAAR2262009].

-   2010/467/EC: On 28th August 2010, the 17th August 2010 decision is corrected. The added statment is that if routine inspections from the past three years show that eradication does not seem feasible within a year, local measures should focus on pest contention and suppression within the selected area but maintaining eradication as a long-term objective [@eucomissionCorreccionErroresDecision2011]. 

-   Order AAR/2802/2010 and Resolution AAR/2802/2010: On 20th October 2010, the delimited area containing the pest is published at municipality level [@generalitatdecatalunyaResolucioAAR28022010].

-   Order AAM/56/2011: On April 12th 2011, the Order ARP/343/2006 is modified. The main changes are found in articles 8, 9, 11, 12. The key change is that from this year onwards, GENCAT continues to inspect each year, publish the delimited area, and inform local authorities through outreach activities. Treatment and removal costs, however, are transferred to municipalities and private owners. The transferred activities are mandatory and their procedure is carefully described including the type of chemicals to use, the times of the year when they should be done, and the specific places where trees should be destroyed [@generalitatdecatalunyaORDREAAM562011]. 

- Repeal to Decision 2007/365/EC: On 21st March 2018, the EU Comssion decides to repeal the 2007/365/EC decision to prevent the introduction and spread of the RPW within the European Union. The repeal started applying on 1st October 2018. The decision states annual surveys by countries enforcing the decision reported that the pest had spread to all vulnerable areas [@eucomissionCommissionImplementingDecision2018].

Appendix B: Variable symbols
========

\setcounter{table}{0}
\setcounter{figure}{0}
\renewcommand{\thetable}{B\arabic{table}}
\renewcommand{\thefigure}{B\arabic{figure}}


For reference, Appendix B summarises variable symbols for stocks (Table \ref{tab:stocks}) and flows (Table \ref{tab:flows}). These were not included in the text to avoid repetition although some readers might find these tables helpful.

```{r stock table summary, echo=FALSE}
Summary_Stock <- as.vector(c("Healthy","Infested","In treatment","Lost","Replanted","Total population"))
Stock <- as.vector(c("$S_t^H$","$S_t^I$","$S_t^{T}$","$S_t^L$","$S_t^R$","$S_t$"))
df_stock <- as_tibble(Stock,Summary_Stock)

colnames(df_stock) <- c("Stock")
kable(df_stock, caption = "\\label{tab:stocks}Palm tree stocks.", booktabs = T,escape = F) %>%
kable_styling(latex_options = c("hold_position"))
```

```{r flows table summary, echo=FALSE}

Summary_Flow <- as.vector(c("Replanted",
                            "Failed prevention",
                            "Untreated",
                            "Treated",
                            "Failed treatment",
                            "Successful treatment"))
Flow <- as.vector(c("$F_{t,t-1}^R$",
                    "$F_{t,t-1}^{FP}$",
                    "$F_{t,t-1}^{UTR}$",
                    "$F_{t,t-1}^{TR}$",
                    "$F_{t,t-1}^{FT}$",
                    "$F_{t,t-1}^{ST}$"
                    ))	

df_flow <- as_tibble(Flow,Summary_Flow)
colnames(df_flow) <- c("Flow")
kable(df_flow, caption = "\\label{tab:flows}Palm tree flows.", booktabs = T,escape = F) %>%
kable_styling(latex_options = c("hold_position"))
```

Appendix C: Detailed results 
========

\setcounter{table}{0}
\setcounter{figure}{0}
\renewcommand{\thetable}{C\arabic{table}}
\renewcommand{\thefigure}{C\arabic{figure}}

This appendix expands on the Results section by providing detailed costs and benefits. The tables and figures that appear in the main text are aggregated versions of the ones found in subsequent pages.

```{r gencat cost tables, echo=FALSE}
gencat%>%
  set_names(c("Year","GENCAT cost","GENCAT cost present"))%>%
kable(
  caption = "\\label{tab:gencat_table}GENCAT costs associated to RPW expenditure over time.",
  booktabs = T,
  escape = F,
  linesep= ""
) %>%
  kable_styling(latex_options = c("hold_position"))%>%
  footnote(general= paste0("Total cost of the evaluated policies for all years is ",
                         round(sum(gencat$gov_cost_present),digits = 0),
                         "."," Source: GENCAT, 2018."),
                     footnote_as_chunk = T, threeparttable = TRUE)
```

\begin{figure}[!htb]
\centerline{\includegraphics[width=30pc]{gencat_plot.png}}
\caption{Government (GENCAT) expenditure over time on the palm tree conservation policy associated to the red palm weevil. Costs increase each year between 2005 and 2009. In 2011, expenditure is more than halved. This is due to inspection, prevention, treatment, and removal costs being transferred to municipalities and private tree owners.}
\label{fig:gencat_plot} 
\end{figure}

```{r date_cost_low table}
date_cost_low%>%
  set_names(c("Year","Replanting","Inspection","Prevention","Treatment","Removal","Total"))%>%
  kable(
    caption = "\\label{tab:date_costs_low}Management costs (lower bound) for date palms over time.",
    booktabs = T,
    escape = F,
    linesep= ""
  ) %>%
  kable_styling(latex_options = c("hold_position"))%>%
  footnote(general=paste("Total cost of all activities for all years is ",round(sum(date_cost_low$total),digits = 0),".",sep = ""),
           footnote_as_chunk = T, threeparttable = TRUE)
```

```{r date_cost_high table}
date_cost_high%>%
  set_names(c("Year","Replanting","Inspection","Prevention","Treatment","Removal","Total"))%>%
  kable(
    caption = "\\label{tab:date_costs_high}Management costs (upper bound) for date palms over time.",
    booktabs = T,
    escape = F,
    linesep= ""
  ) %>%
  kable_styling(latex_options = c("hold_position"))%>%
   footnote(general=paste("Total cost of all activities for all years is ",round(sum(date_cost_high$total),digits = 0),".",sep = ""),
           footnote_as_chunk = T, threeparttable = TRUE)


```

\begin{figure}[!htb]
\centerline{\includegraphics[width=30pc]{date_costs.png}}
\caption{Management costs for date palms by activity for lower and upper estimations between 2011 and 2017. The lower and upper bounds show a similar pattern for prevention and inspection costs. The main difference between the two bounds is that removal costs are increasing for the upper bound. This is due to a larger volume of date palms and the significant (in comparison to the others) unitary costs of removing an infested tree.}
\label{fig:date_costs} 
\end{figure}

```{r canary_cost_low table}
canary_cost_low%>%
  set_names(c("Year","Replanting","Inspection","Prevention","Treatment","Removal","Total"))%>%
  kable(
    caption = "\\label{tab:canary_costs_low}Management costs (lower bound) for canary palms over time.",
    booktabs = T,
    escape = F,
    linesep= ""
  ) %>%
  kable_styling(latex_options = c("hold_position"))%>%
   footnote(general=paste("Total cost of all activities for all years is ",round(sum(canary_cost_low$total),digits = 0),".",sep = ""), footnote_as_chunk = T, threeparttable = TRUE)
```

```{r canary_costs_high}
canary_cost_high%>%
  set_names(c("Year","Replanting","Inspection","Prevention","Treatment","Removal","Total"))%>%
  kable(
    caption = "Management costs (upper bound) for canary palms over time.",
    booktabs = T,
    escape = F,
    linesep= ""
  ) %>%
  kable_styling(latex_options = c("hold_position"))%>%
   footnote(general=paste("Total cost of all activities for all years is ",round(sum(canary_cost_high$total),digits = 0),".",sep = ""), footnote_as_chunk = T, threeparttable = TRUE)
```

\begin{figure}[!htb]
\centerline{\includegraphics[width=30pc]{canary_costs.png}}
\caption{Management costs over time for canary palms by activity between 2011 and 2017. The biggest expenditure is on removal costs since this species experienced the sharpest decline. In the upper bound, as the epidemic unfolds, more trees become infested that require large volumes of treatment. In the lower bound, the second largest cost is prevention.}
\label{fig:canary_costs} 
\end{figure}

```{r total_costs, echo=FALSE}
total_costs%>%
   set_names(c("Year","GENCAT","Date","Canary","Total","Date","Canary","Total"))%>%
  kable(
    caption = "Total costs for canary and date palms over time.",
    booktabs = T,
    escape = F,
    linesep= "") %>%
  kable_styling(latex_options = c("hold_position"))%>%
  add_header_above(c("","","Lower"=3,"Higher"=3))%>%
  footnote(general=paste("Total for lower bound is ",round(sum(total_costs$total_lower),digits=0),", total for higher bound is ",round(sum(total_costs$total_upper),digits=0),".",sep = ""), footnote_as_chunk = T, threeparttable = TRUE)
```

\begin{figure}[!htb]
\centerline{\includegraphics[width=30pc]{costs_combined_total.png}}
\caption{Total costs over time for GENCAT, date and canary palms between 2005 and 2017. GENCAT costs are the same for both bounds. In the upper bound (bottom), GENCAT costs appear smaller in contrast to canary palms. A bigger estimation of palms, led to a larger expenditure on removal costs. In both scenarios, the second largest cost is associated to date palms.}
\label{fig:costs_combined_total} 
\end{figure}

```{r carbon benefits table}
carbon_benefits%>%
  set_names(c("Year","Date","Canary","Total","Date","Canary","Total"))%>%
kable(
    caption = "\\label{tab:carbon_costs}Carbon sequestration values over time.",
    booktabs = T,
    escape = F,
    linesep= ""
  ) %>%
  kable_styling(latex_options = c("hold_position"))%>%
  add_header_above(c("","Lower"=3,"Higher"=3))%>%
  footnote(general=
    paste0("Combining the totals for all years for both species yields a lower bound of ",
           round(sum(carbon_benefits$total_lower),digits=0)," and a higher bound of ",
           round(sum(carbon_benefits$total_upper),digits=0),"."),
           footnote_as_chunk = T, threeparttable = TRUE)

```

```{r echo=FALSE, include=FALSE}
df_date%>%
  dplyr::filter(run==4)%>%
  dplyr::select(time,
        sHeal,
         sInf,
         sTre,
         Replanting,
         Failed_prevention,
         Untreated,
         Treated,
         Failed_treatment,
         Successful_treatment,Total_population)
```

Appendix D: Coefficient tables
========

\setcounter{table}{0}
\setcounter{figure}{0}
\renewcommand{\thetable}{D\arabic{table}}
\renewcommand{\thefigure}{D\arabic{figure}}

```{r date_palms_model, echo=FALSE}
stepAIC(object=lm_date, k =log(n))%>%
  tidy()%>%
kable(
    caption = "Date palms model estimates",
    booktabs = T,
    escape = F,
    linesep= ""
  ) %>%
  kable_styling(latex_options = c("hold_position"))
```


```{r canary_palms_model, echo=FALSE}
stepAIC(object=lm_canary, k =log(n))%>%
  tidy()%>%
  kable(
    caption = "Canary palms model estimates",
    booktabs = T,
    escape = F,
    linesep= ""
  ) %>%
  kable_styling(latex_options = c("hold_position"))
```


\pagebreak
\setlength{\parindent}{-0.5in}
      \setlength{\leftskip}{0.5in}
      \setlength{\parskip}{8pt}
\singlespacing      
\sloppy
References {#references .unnumbered}
==========

